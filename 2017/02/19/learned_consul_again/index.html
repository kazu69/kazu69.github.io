<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Consulを再度学んだ | 69log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="consulを少し触ったままだったので、ちゃんと学んでみた。と言っても一通り触ったくらいであるが。 あらためて試すにあたり、Official Consul Docker Imageを使用してクラスタを構成した。">
<meta property="og:type" content="article">
<meta property="og:title" content="Consulを再度学んだ">
<meta property="og:url" content="http://blog.kazu69.net/2017/02/19/learned_consul_again/index.html">
<meta property="og:site_name" content="69log">
<meta property="og:description" content="consulを少し触ったままだったので、ちゃんと学んでみた。と言っても一通り触ったくらいであるが。 あらためて試すにあたり、Official Consul Docker Imageを使用してクラスタを構成した。">
<meta property="og:locale" content="ja">
<meta property="og:updated_time" content="2017-02-27T13:51:57.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Consulを再度学んだ">
<meta name="twitter:description" content="consulを少し触ったままだったので、ちゃんと学んでみた。と言っても一通り触ったくらいであるが。 あらためて試すにあたり、Official Consul Docker Imageを使用してクラスタを構成した。">
  
    <link rel="alternative" href="/atom.xml" title="69log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-9196861-14', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head></html>
<body>
    <header role="header">
  <div class="header cf">
    <div class="title-content">
      <h1>
        <a href="/">69log</a>
      </h1>
      
        <h2>
          <a href="/">福岡でwebの仕事をしています</a>
        </h2>
      
    </div>

    <div class="nav-content cf">
      <nav>
        
          <a href="/" class="nav-link nav-home">home</a>
        
          <a href="/archives" class="nav-link nav-archives">archives</a>
        
        
          <a href="/atom.xml" title="RSS Feed" class="icon nav-link nav-feed"></a>
        
      </nav>
      <div class="header-search">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://blog.kazu69.net"></form>
      </div>
    </div>
  </div>
</header>

    <main role="main" id="main">
      <section><article id="post-learned_consul_again" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    
      
  
    <h1 class="article-title" itemprop="name">
      Consulを再度学んだ
    </h1>
  

    
    <div class="article-meta clr">
      <time datetime="2017-02-19T14:34:45.000Z" itemprop="datePublished">2017-02-19</time>

      
  <div class="article-category">
    <a class="article-category-link" href="/categories/memo/">memo</a>
  </div>


    </div>
  </header>

  <div class="article-entry" itemprop="articleBody">
    <div class="article-gallery">
      
    </div>
    
      <p>consulを少し触ったままだったので、ちゃんと学んでみた。<br>と言っても一通り触ったくらいであるが。</p>
<p>あらためて試すにあたり、<a href="https://hub.docker.com/_/consul/" target="_blank" rel="noopener">Official Consul Docker Image</a>を使用してクラスタを構成した。</p>
<a id="more"></a>

<h2 id="counsulのおさらい"><a href="#counsulのおさらい" class="headerlink" title="counsulのおさらい"></a>counsulのおさらい</h2><p>consulをざっくりとおさらい。<br>複数のサーバーをクラスタ化して、オーケストレーションするツール。<br>クラスタ内のサーバー同士をDNSインターフェイスを通してIPベース相互検出し(Discovery)、健全性を確認し(Health Check)、特定のサーバーへのトラフィックを回避する(Load Balancing)を行う。</p>
<p>RESTベースの外部API(HTTP API)を提供しており、サーバー情報はキーバリュースストアで保持されている。</p>
<h2 id="dockerでクラスタ構成を作る"><a href="#dockerでクラスタ構成を作る" class="headerlink" title="dockerでクラスタ構成を作る"></a>dockerでクラスタ構成を作る</h2><p>consulはサーバとクライアントという2つのコンポーネントで構成され、いずれかの状態で起動する必要がある。<br>クライアントモードでは各サーバーと通信をする。<br>サーバーモードでは奇数台で構成されることを期待されていて、それぞれがGossip Protocolで通信し、Raftアルゴリズムに基づいてリーダーを選出する。</p>
<p>今回はdockerを使って以下のような構成を使っておさらいする</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># server</span><br><span class="line">consul --</span><br><span class="line">         `- consul1 (leader) 172.16.238.10</span><br><span class="line">         `- consul2          172.16.238.11</span><br><span class="line">         `- consul3          172.16.238.12</span><br><span class="line"># agent</span><br><span class="line">nginx  --</span><br><span class="line">         `- nginx1           172.16.238.13</span><br><span class="line">         `- nginx2           172.16.238.14</span><br><span class="line">         `- nginx3           172.16.238.15</span><br></pre></td></tr></table></figure>

<p>ということでserver 3コンテナを起動してみる。</p>
<p>ちなみにconsulでは次のポートをデフォルトで使用する。</p>
<table>
<thead>
<tr>
<th>機能</th>
<th>protocol</th>
<th>port</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>Server RPC</td>
<td>TCP</td>
<td>8300</td>
<td>他のAgentからのリクエストを受付る</td>
</tr>
<tr>
<td>Serf LAN</td>
<td>TCP and UDP</td>
<td>8301</td>
<td>LAN上のゴシッププロトコル。すべてのAgentが使用する。</td>
</tr>
<tr>
<td>Serf WAN</td>
<td>TCP and UDP</td>
<td>8302</td>
<td>WAN上のゴシッププロトコル。他のサーバーとの通信に使用。</td>
</tr>
<tr>
<td>CLI RPC</td>
<td>TCP</td>
<td>8400</td>
<td>CLIからの入力を処理する。すべてのAgentが使用する。</td>
</tr>
<tr>
<td>HTTP API</td>
<td>TCP</td>
<td>8500</td>
<td>クライアントがHTTP API を受付る</td>
</tr>
<tr>
<td>DNS Interface</td>
<td>TCP and UDP</td>
<td>8600</td>
<td>DNSクエリを解決する</td>
</tr>
</tbody></table>
<p>今回は外からも利用するので一つだけ書くポートをフォワードしておく。</p>
<h2 id="リーダー選出"><a href="#リーダー選出" class="headerlink" title="リーダー選出"></a>リーダー選出</h2><p>指定数以上のサーバーが起動したことで、リーダーが選出されていることを確認する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># リーダーのnodeの情報取得</span></span><br><span class="line">curl -s http://localhost:8500/v1/status/leader | jq .</span><br><span class="line"><span class="string">"172.16.238.10:8300"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># agentのnode情報取得</span></span><br><span class="line">curl -s http://localhost:8500/v1/status/peers | jq .</span><br><span class="line">[</span><br><span class="line">  <span class="string">"172.16.238.10:8300"</span>,</span><br><span class="line">  <span class="string">"172.16.238.12:8300"</span>,</span><br><span class="line">  <span class="string">"172.16.238.11:8300"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="agentの追加"><a href="#agentの追加" class="headerlink" title="agentの追加"></a>agentの追加</h3><p>3台起動してるnginxコンテナをagentモードでクラスタに追加する。<br>(追加時に合わせて幾つか死活監視を試せるようにしている)</p>
<p>起動しているコンテナは以下の状態</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS              PORTS                                                                                                                                       NAMES</span><br><span class="line">c48eb5e1c99a        learnconsul_nginx2   <span class="string">"nginx -g 'daemon ..."</span>   24 hours ago        Up 24 hours         443/tcp, 0.0.0.0:8000-&gt;80/tcp                                                                                                               nginx2</span><br><span class="line">1bd432bd0b98        consul:latest        <span class="string">"docker-entrypoint..."</span>   24 hours ago        Up 24 hours         8300-8302/tcp, 8400/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                                                        consul2</span><br><span class="line">7917ff526a10        learnconsul_nginx1   <span class="string">"nginx -g 'daemon ..."</span>   24 hours ago        Up 24 hours         443/tcp, 0.0.0.0:8080-&gt;80/tcp                                                                                                               nginx1</span><br><span class="line">f72330ed0182        consul:latest        <span class="string">"docker-entrypoint..."</span>   24 hours ago        Up 24 hours         8300-8302/tcp, 8400/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                                                        consul3</span><br><span class="line">5c40e078481e        learnconsul_nginx3   <span class="string">"nginx -g 'daemon ..."</span>   24 hours ago        Up 24 hours         443/tcp, 0.0.0.0:8888-&gt;80/tcp                                                                                                               nginx3</span><br><span class="line">f7270595eda4        consul:latest        <span class="string">"docker-entrypoint..."</span>   24 hours ago        Up 24 hours         0.0.0.0:8300-8302-&gt;8300-8302/tcp, 0.0.0.0:8400-&gt;8400/tcp, 8301-8302/udp, 0.0.0.0:8500-&gt;8500/tcp, 8600/udp, 8600/tcp, 0.0.0.0:8600-&gt;53/udp   consul1</span><br></pre></td></tr></table></figure>

<p>nodeを追加していく</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># configファイルをコンテナにコピー</span></span><br><span class="line">docker cp config/nginx1 nginx1:/etc/consul.d</span><br><span class="line"><span class="comment"># clusterにjoinする</span></span><br><span class="line">docker <span class="built_in">exec</span> -d -t nginx1 consul agent -config-file=/etc/consul.d/nginx1</span><br><span class="line"><span class="comment"># ttl health check用のスクリプトを起動</span></span><br><span class="line">docker <span class="built_in">exec</span> -d -t nginx1 bash -c <span class="string">'./http_request nginx1'</span></span><br><span class="line"> </span><br><span class="line">consul1    |     2017/01/25 07:50:51 [INFO] serf: EventMemberJoin: nginx1 172.16.238.13</span><br><span class="line">consul1    |     2017/01/25 07:50:51 [INFO] consul: member <span class="string">'nginx1'</span> joined, marking health alive</span><br><span class="line">consul2    |     2017/01/25 07:50:51 [INFO] serf: EventMemberJoin: nginx1 172.16.238.13</span><br><span class="line">consul3    |     2017/01/25 07:50:51 [INFO] serf: EventMemberJoin: nginx1 172.16.238.13</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 以下nginx1と同じ処理を行う</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># nginx2</span></span><br><span class="line">docker cp config/nginx2 nginx2:/etc/consul.d</span><br><span class="line">docker <span class="built_in">exec</span> -d -t nginx2 consul agent -config-file=/etc/consul.d/nginx2</span><br><span class="line">docker <span class="built_in">exec</span> -d -t nginx2 bash -c <span class="string">'./http_request nginx2'</span></span><br><span class="line"> </span><br><span class="line">consul1    |     2017/01/25 07:51:31 [INFO] serf: EventMemberJoin: nginx2 172.16.238.14</span><br><span class="line">consul1    |     2017/01/25 07:51:31 [INFO] consul: member <span class="string">'nginx2'</span> joined, marking health alive</span><br><span class="line">consul2    |     2017/01/25 07:51:31 [INFO] serf: EventMemberJoin: nginx2 172.16.238.14</span><br><span class="line">consul3    |     2017/01/25 07:51:31 [INFO] serf: EventMemberJoin: nginx2 172.16.238.14</span><br><span class="line"> </span><br><span class="line"><span class="comment"># nginx3</span></span><br><span class="line">docker cp config/nginx3 nginx3:/etc/consul.d</span><br><span class="line">docker <span class="built_in">exec</span> -d -t nginx3 consul agent -config-file=/etc/consul.d/nginx3</span><br><span class="line">docker <span class="built_in">exec</span> -d -t nginx3 bash -c <span class="string">'./http_request nginx3'</span></span><br><span class="line"> </span><br><span class="line">consul1    |     2017/01/25 07:52:06 [INFO] serf: EventMemberJoin: nginx3 172.16.238.15</span><br><span class="line">consul1    |     2017/01/25 07:52:06 [INFO] consul: member <span class="string">'nginx3'</span> joined, marking health alive</span><br><span class="line">consul2    |     2017/01/25 07:52:06 [INFO] serf: EventMemberJoin: nginx3 172.16.238.15</span><br><span class="line">consul3    |     2017/01/25 07:52:06 [INFO] serf: EventMemberJoin: nginx3 172.16.238.15</span><br></pre></td></tr></table></figure>

<p>追加されていることをapiを通じて確認する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ローカルエージェント(consul1)で既知のノードを返します</span></span><br><span class="line">curl -s http://localhost:8500/v1/catalog/nodes | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"consul1"</span>,</span><br><span class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.10"</span>,</span><br><span class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.10"</span>,</span><br><span class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.10"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Meta"</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 5,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 9</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"consul2"</span>,</span><br><span class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.11"</span>,</span><br><span class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.11"</span>,</span><br><span class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.11"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Meta"</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 4,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 20</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</span><br><span class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.12"</span>,</span><br><span class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.12"</span>,</span><br><span class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.12"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Meta"</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 6,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 8</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.13"</span>,</span><br><span class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.13"</span>,</span><br><span class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.13"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Meta"</span>: null,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 28,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 29</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</span><br><span class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.14"</span>,</span><br><span class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.14"</span>,</span><br><span class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.14"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Meta"</span>: null,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 119,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 120</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</span><br><span class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.15"</span>,</span><br><span class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.15"</span>,</span><br><span class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.15"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Meta"</span>: null,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 132,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 134</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ローカルエージェント(consul1)で登録された全ての service を返す</span></span><br><span class="line">curl -s http://localhost:8500/v1/agent/services | jq .</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"consul"</span>: &#123;</span><br><span class="line">    <span class="string">"ID"</span>: <span class="string">"consul"</span>,</span><br><span class="line">    <span class="string">"Service"</span>: <span class="string">"consul"</span>,</span><br><span class="line">    <span class="string">"Tags"</span>: [],</span><br><span class="line">    <span class="string">"Address"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Port"</span>: 8300,</span><br><span class="line">    <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 0,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ローカルエージェント(consul1) のserf エージェントが見えているメンバを返す</span></span><br><span class="line">curl -s http://localhost:8500/v1/agent/members | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.13"</span>,</span><br><span class="line">    <span class="string">"Port"</span>: 8301,</span><br><span class="line">    <span class="string">"Tags"</span>: &#123;</span><br><span class="line">      <span class="string">"build"</span>: <span class="string">"0.7.2:'a9afa0c"</span>,</span><br><span class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</span><br><span class="line">      <span class="string">"role"</span>: <span class="string">"node"</span>,</span><br><span class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</span><br><span class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</span><br><span class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Status"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMin"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMax"</span>: 5,</span><br><span class="line">    <span class="string">"ProtocolCur"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMin"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMax"</span>: 4,</span><br><span class="line">    <span class="string">"DelegateCur"</span>: 4</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"nginx2"</span>,</span><br><span class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.14"</span>,</span><br><span class="line">    <span class="string">"Port"</span>: 8301,</span><br><span class="line">    <span class="string">"Tags"</span>: &#123;</span><br><span class="line">      <span class="string">"build"</span>: <span class="string">"0.7.2:'a9afa0c"</span>,</span><br><span class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</span><br><span class="line">      <span class="string">"role"</span>: <span class="string">"node"</span>,</span><br><span class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</span><br><span class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</span><br><span class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Status"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMin"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMax"</span>: 5,</span><br><span class="line">    <span class="string">"ProtocolCur"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMin"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMax"</span>: 4,</span><br><span class="line">    <span class="string">"DelegateCur"</span>: 4</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"nginx3"</span>,</span><br><span class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.15"</span>,</span><br><span class="line">    <span class="string">"Port"</span>: 8301,</span><br><span class="line">    <span class="string">"Tags"</span>: &#123;</span><br><span class="line">      <span class="string">"build"</span>: <span class="string">"0.7.2:'a9afa0c"</span>,</span><br><span class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</span><br><span class="line">      <span class="string">"role"</span>: <span class="string">"node"</span>,</span><br><span class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</span><br><span class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</span><br><span class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Status"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMin"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMax"</span>: 5,</span><br><span class="line">    <span class="string">"ProtocolCur"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMin"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMax"</span>: 4,</span><br><span class="line">    <span class="string">"DelegateCur"</span>: 4</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"consul1"</span>,</span><br><span class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.10"</span>,</span><br><span class="line">    <span class="string">"Port"</span>: 8301,</span><br><span class="line">    <span class="string">"Tags"</span>: &#123;</span><br><span class="line">      <span class="string">"build"</span>: <span class="string">"0.7.5:'21f2d5a"</span>,</span><br><span class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</span><br><span class="line">      <span class="string">"expect"</span>: <span class="string">"3"</span>,</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">      <span class="string">"port"</span>: <span class="string">"8300"</span>,</span><br><span class="line">      <span class="string">"role"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</span><br><span class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</span><br><span class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Status"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMin"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMax"</span>: 5,</span><br><span class="line">    <span class="string">"ProtocolCur"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMin"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMax"</span>: 5,</span><br><span class="line">    <span class="string">"DelegateCur"</span>: 4</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"consul3"</span>,</span><br><span class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.12"</span>,</span><br><span class="line">    <span class="string">"Port"</span>: 8301,</span><br><span class="line">    <span class="string">"Tags"</span>: &#123;</span><br><span class="line">      <span class="string">"build"</span>: <span class="string">"0.7.5:'21f2d5a"</span>,</span><br><span class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">      <span class="string">"port"</span>: <span class="string">"8300"</span>,</span><br><span class="line">      <span class="string">"role"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</span><br><span class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</span><br><span class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Status"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMin"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMax"</span>: 5,</span><br><span class="line">    <span class="string">"ProtocolCur"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMin"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMax"</span>: 5,</span><br><span class="line">    <span class="string">"DelegateCur"</span>: 4</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"consul2"</span>,</span><br><span class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.11"</span>,</span><br><span class="line">    <span class="string">"Port"</span>: 8301,</span><br><span class="line">    <span class="string">"Tags"</span>: &#123;</span><br><span class="line">      <span class="string">"build"</span>: <span class="string">"0.7.5:'21f2d5a"</span>,</span><br><span class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">      <span class="string">"port"</span>: <span class="string">"8300"</span>,</span><br><span class="line">      <span class="string">"role"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</span><br><span class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</span><br><span class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Status"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMin"</span>: 1,</span><br><span class="line">    <span class="string">"ProtocolMax"</span>: 5,</span><br><span class="line">    <span class="string">"ProtocolCur"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMin"</span>: 2,</span><br><span class="line">    <span class="string">"DelegateMax"</span>: 5,</span><br><span class="line">    <span class="string">"DelegateCur"</span>: 4</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service consulのhealth check</span></span><br><span class="line">curl -s http://localhost:8500/v1/health/service/consul | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">      <span class="string">"Node"</span>: <span class="string">"consul1"</span>,</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.10"</span>,</span><br><span class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.10"</span>,</span><br><span class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.10"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"Meta"</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 5,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 9</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Service"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"Service"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"Tags"</span>: [],</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"Port"</span>: 8300,</span><br><span class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 5,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 9</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Checks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"consul1"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 5,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 5</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">      <span class="string">"Node"</span>: <span class="string">"consul2"</span>,</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.11"</span>,</span><br><span class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.11"</span>,</span><br><span class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.11"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"Meta"</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 4,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 35</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Service"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"Service"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"Tags"</span>: [],</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"Port"</span>: 8300,</span><br><span class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 4,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 35</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Checks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"consul2"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 8,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 8</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</span><br><span class="line">      <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.12"</span>,</span><br><span class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.12"</span>,</span><br><span class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.12"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"Meta"</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 6,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 32</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Service"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"Service"</span>: <span class="string">"consul"</span>,</span><br><span class="line">      <span class="string">"Tags"</span>: [],</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"Port"</span>: 8300,</span><br><span class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 6,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 32</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Checks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 7,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 7</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="health-check-死活監視-について"><a href="#health-check-死活監視-について" class="headerlink" title="health check(死活監視)について"></a>health check(死活監視)について</h3><p>consulのhealth checkには次の種類のものがある。</p>
<table>
<thead>
<tr>
<th>check</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>Script + Interval</td>
<td>Exit code 0でpassing、Exit code 1でWarning、それ以外でcriticalとなるスクリプトを実行する</td>
</tr>
<tr>
<td>HTTP + Interval</td>
<td>curlなどでのHTTPリクエスト。2xxステータスでpassing。429 Too Many Requestsでwarning。それ以外はcritical。</td>
</tr>
<tr>
<td>TCP + Interval</td>
<td>指定ホストにTCPで接続を試みる。接続成功でpassing、それ以外はciritcalとなる。</td>
</tr>
<tr>
<td>Time to Live (TTL)</td>
<td>アプリケーションが自身の状態をチェックして通知する。通知状態はTTLの間保持される。</td>
</tr>
<tr>
<td>Docker + Interval</td>
<td>DockerコンテナにHTTPまたはSocket通信し、適切な終了コードかをチェックする</td>
</tr>
</tbody></table>
<p>今回は以下の機能を試す。</p>
<ul>
<li>HTTP + Interval</li>
<li>TCP + Interval</li>
<li>Time to Live (TTL)</li>
</ul>
<p>ちなみにTime to Liveはちょっとわかりにくいが、自身のconsul http apiを実行する。<br>例えばpass状態を送る場合は <a href="http://localhost:8500/v1/agent/check/pass/{CHECK_ID}" target="_blank" rel="noopener">http://localhost:8500/v1/agent/check/pass/{CHECK_ID}</a> にリクエストする。</p>
<p>今回のhealth checkの設定は以下のようにしている。<br>(すでにclusterにjoinするときに設定は行っている)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nginx1の場合</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"checks"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">      <span class="string">"http"</span>: <span class="string">"http://localhost:80"</span>,</span><br><span class="line">      <span class="string">"interval"</span>: <span class="string">"10s"</span>,</span><br><span class="line">      <span class="string">"timeout"</span>: <span class="string">"1s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"Nginx Status"</span>,</span><br><span class="line">      <span class="string">"ttl"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">      <span class="string">"tcp"</span>: <span class="string">"172.16.238.13:80"</span>,</span><br><span class="line">      <span class="string">"interval"</span>: <span class="string">"10s"</span>,</span><br><span class="line">      <span class="string">"timeout"</span>: <span class="string">"1s"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service(nginx1、nginx2、nginx3)ごとのstatusを取得してみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service nginxのhealth check</span></span><br><span class="line">curl -s http://localhost:8500/v1/health/service/proxy | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.13"</span>,</span><br><span class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.13"</span>,</span><br><span class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.13"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"Meta"</span>: null,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 12,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 13</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Service"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"proxy"</span>,</span><br><span class="line">      <span class="string">"Service"</span>: <span class="string">"proxy"</span>,</span><br><span class="line">      <span class="string">"Tags"</span>: [</span><br><span class="line">        <span class="string">"nginx"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.13"</span>,</span><br><span class="line">      <span class="string">"Port"</span>: 80,</span><br><span class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 13,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 13</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Checks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"HTTP GET http://172.16.238.13: 200 OK Output: &lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body &#123;\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    &#125;\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 14,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 17</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 15,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 227</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 12,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 12</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.13:80: Success"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 16,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 18</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.14"</span>,</span><br><span class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.14"</span>,</span><br><span class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.14"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"Meta"</span>: null,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 22,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 25</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Service"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"proxy"</span>,</span><br><span class="line">      <span class="string">"Service"</span>: <span class="string">"proxy"</span>,</span><br><span class="line">      <span class="string">"Tags"</span>: [</span><br><span class="line">        <span class="string">"nginx"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.14"</span>,</span><br><span class="line">      <span class="string">"Port"</span>: 80,</span><br><span class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 25,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 25</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Checks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"HTTP GET http://172.16.238.14: 200 OK Output: &lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body &#123;\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    &#125;\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 26,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 30</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"nginx2"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 27,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 223</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 22,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 22</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.14:80: Success"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 28,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 29</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.15"</span>,</span><br><span class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</span><br><span class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.15"</span>,</span><br><span class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.15"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"Meta"</span>: null,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 37,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 38</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Service"</span>: &#123;</span><br><span class="line">      <span class="string">"ID"</span>: <span class="string">"proxy"</span>,</span><br><span class="line">      <span class="string">"Service"</span>: <span class="string">"proxy"</span>,</span><br><span class="line">      <span class="string">"Tags"</span>: [</span><br><span class="line">        <span class="string">"nginx"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.15"</span>,</span><br><span class="line">      <span class="string">"Port"</span>: 80,</span><br><span class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"CreateIndex"</span>: 38,</span><br><span class="line">      <span class="string">"ModifyIndex"</span>: 38</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Checks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"HTTP GET http://172.16.238.15: 200 OK Output: &lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body &#123;\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    &#125;\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 41,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 42</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"nginx3"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 39,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 228</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 37,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 37</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</span><br><span class="line">        <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.14:80: Success"</span>,</span><br><span class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"CreateIndex"</span>: 40,</span><br><span class="line">        <span class="string">"ModifyIndex"</span>: 44</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>consul serverのnodeを一つダウンしてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop consul3</span><br><span class="line">consul3</span><br></pre></td></tr></table></figure>

<p>consul3の状態を確認する</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://localhost:8500/v1/health/node/consul3 | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"Agent not live or unreachable"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 7,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 748</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>consul3 を復帰させる</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker start consul3</span><br><span class="line">consul3</span><br></pre></td></tr></table></figure>

<p>再び状態を確認してみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://localhost:8500/v1/health/node/consul3 | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 7,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 800</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>nginx1のnodeのhttpチェックをcriticalな状態にしてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> nginx1 mv /usr/share/nginx/html/index.html /usr/share/nginx/html/index.txt</span><br><span class="line">curl -s http://localhost:8500/v1/health/node/nginx1 | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"HTTP GET http://localhost:80: 403 Forbidden Output: &lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\r\n&lt;body bgcolor=\"white\"&gt;\r\n&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx/1.11.10&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 614,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 803</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 612,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 806</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 610,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 610</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.13:80: Success"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 613,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 613</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>apiからciriticalなものだけ取得してみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://localhost:8500/v1/health/state/critical | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"HTTP GET http://localhost:80: 403 Forbidden Output: &lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\r\n&lt;body bgcolor=\"white\"&gt;\r\n&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx/1.11.10&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 614,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 803</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="メンテナンスモード"><a href="#メンテナンスモード" class="headerlink" title="メンテナンスモード"></a>メンテナンスモード</h3><p>当たり前ではなるが、nodeをメンテナス状態にできる。<br>nginx1をメンテナンスモードにする。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it nginx1 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># maintenance modeをenableにして、理由にtestとする</span></span><br><span class="line">consul maint -reason <span class="built_in">test</span> -<span class="built_in">enable</span></span><br><span class="line">Node maintenance is now enabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># maintenance の状態を確認</span></span><br><span class="line">consul maint</span><br><span class="line">Node:</span><br><span class="line">  Name:   nginx1</span><br><span class="line">  Reason: <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>nginx1の状態を確認する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://localhost:8500/v1/health/node/nginx1 | jq .</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"_node_maintenance"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"Node Maintenance Mode"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">"test"</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 894,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 894</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"HTTP GET http://localhost:80: 200 OK Output: "</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 614,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 869</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 612,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 928</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 610,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 610</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.13:80: Success"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"CreateIndex"</span>: 613,</span><br><span class="line">    <span class="string">"ModifyIndex"</span>: 613</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>メンテナンスモードを解除する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># maintenance modeをdisableにする</span></span><br><span class="line">consul maint -<span class="built_in">disable</span></span><br><span class="line">Node maintenance is now disabled</span><br><span class="line"></span><br><span class="line">consul maint</span><br><span class="line"><span class="comment"># なし</span></span><br></pre></td></tr></table></figure>

<h3 id="event処理"><a href="#event処理" class="headerlink" title="event処理"></a>event処理</h3><p>イベントを監視して、発火時に任意の処理を実行することができる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># testイベントをwatchする</span></span><br><span class="line">docker <span class="built_in">exec</span> -it consule1 /bin/sh</span><br><span class="line">consul watch -<span class="built_in">type</span>=event -name=<span class="built_in">test</span> <span class="built_in">echo</span> <span class="string">"test"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># testイベントを発行</span></span><br><span class="line">docker <span class="built_in">exec</span> -it nginx1 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># consul1</span></span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>watchコマンドで状態が変化した際に特定の処理をしてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it consule1 /bin/sh</span><br><span class="line">consul watch -<span class="built_in">type</span>=checks -state=critical <span class="string">"jq ."</span></span><br><span class="line">[]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># nginx1を落とす</span></span><br><span class="line">docker stop nginx1</span><br><span class="line"> </span><br><span class="line"><span class="comment"># criticalが表示される</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</span><br><span class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</span><br><span class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"Output"</span>: <span class="string">"Agent not live or unreachable"</span>,</span><br><span class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="consul-templateを試してみる"><a href="#consul-templateを試してみる" class="headerlink" title="consul-templateを試してみる"></a>consul-templateを試してみる</h3><p><a href="https://github.com/hashicorp/consul-template" target="_blank" rel="noopener">consul-template</a>も試しておく。<br>consul-templateは特定のイベントに応じて、登録しているtemplateからファイルを生成することができる。<br>イベントを監視して、特定のイベントが発火すると登録しているtemplateからファイルを再生成する感じである。</p>
<p>consul-templateで監視できるイベントは</p>
<ul>
<li>datacenter(detacenterの)</li>
<li>file(fileの変更)</li>
<li>key(ストアのkey変更・存在)</li>
<li>ls(kvストアの最上位のkey)</li>
<li>node</li>
<li>secret</li>
<li>service</li>
<li>tree(kvストアのkvペア)</li>
</ul>
<p>例えば、次のようなnodeが追加されるたびにhost名とipを記載したファイルが出力されるもので試してみる。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; range nodes &#125;&#125;</span><br><span class="line"># &#123;&#123;.Node&#125;&#125;</span><br><span class="line">&#123;&#123; .Address &#125;&#125; &#123;&#123;.Node&#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it nginx1 /bin/bash</span><br><span class="line"> </span><br><span class="line"><span class="comment"># -dry でdry run</span></span><br><span class="line">consul-template -consul-addr 127.0.0.1:8500 -template <span class="string">"/etc/consul-template/config.d/templates/hosts.ctmpl:/hosts"</span> -dry</span><br><span class="line"> </span><br><span class="line">&gt; /hosts</span><br><span class="line"> </span><br><span class="line"><span class="comment"># consul1</span></span><br><span class="line">172.16.238.10 consul1</span><br><span class="line"> </span><br><span class="line"><span class="comment"># consul2</span></span><br><span class="line">172.16.238.11 consul2</span><br><span class="line"> </span><br><span class="line"><span class="comment"># consul3</span></span><br><span class="line">172.16.238.12 consul3</span><br><span class="line"> </span><br><span class="line"><span class="comment"># nginx1</span></span><br><span class="line">172.16.238.13 nginx1</span><br></pre></td></tr></table></figure>

<p>node nginx2を追加する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; /hosts</span><br><span class="line"> </span><br><span class="line"><span class="comment"># consul1</span></span><br><span class="line">172.16.238.10 consul1</span><br><span class="line"> </span><br><span class="line"><span class="comment"># consul2</span></span><br><span class="line">172.16.238.11 consul2</span><br><span class="line"> </span><br><span class="line"><span class="comment"># consul3</span></span><br><span class="line">172.16.238.12 consul3</span><br><span class="line"> </span><br><span class="line"><span class="comment"># nginx1</span></span><br><span class="line">172.16.238.13 nginx1</span><br><span class="line"> </span><br><span class="line"><span class="comment"># nginx2</span></span><br><span class="line">172.16.238.14 nginx2</span><br></pre></td></tr></table></figure>

<p>テンプレートが更新されている。</p>
<h3 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h3><p>おさらいとして、今回はdockerの公式イメージでクラスタを構成してみた。<br>consulによるクラスタ構成を以前より意識できた感がある。</p>
<h3 id="repository"><a href="#repository" class="headerlink" title="repository"></a>repository</h3><p><a href="https://github.com/kazu69/docker-consul-example" target="_blank" rel="noopener">docker-consul-example</a></p>

    
  </div>

  
    <footer class="article-footer">

      
        <aside class="google-adsence">
          
<!-- Google Adsence -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4054575508733221" data-ad-slot="9493597992" data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- End Google Adsence -->


        </aside>
      

      <div class="share_content">
  <div class="hatena_sharebox">
    
      <a href="http://b.hatena.ne.jp/entry/blog.kazu69.net/2017/02/19/learned_consul_again/" class="hatena-bookmark-button" data-hatena-bookmark-title="Consulを再度学んだ" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  </div>
  
    <div class="addthis addthis_toolbox addthis_default_style">
      
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
      
      
        <a class="addthis_button_tweet"></a>
      
      
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
      
      
      <!-- <a class="addthis_counter addthis_pill_style"></a> -->
    </div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55a4f49a45ced975"></script>
  
</div>

      
        <a href="http://blog.kazu69.net/2017/02/19/learned_consul_again/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  

  
    
<nav id="article-nav">
  <div class="article-nav">
    
      <a href="/2017/03/23/http-request-using-cors/" id="article-nav-newer" class="article-nav-link article-nav-link-newer">
        <span class="article-nav-caption">Newer - </span>
        <span class="article-nav-title">
          
            Cross-Origin Resource Sharing(CORS)を使用したHTTPリクエスト
          
        </span>
      </a>
    
    
      <a href="/2017/01/28/response_improvement_using_http2_server_push_service_worke/" id="article-nav-older" class="article-nav-link article-nav-link-older">
        <span class="article-nav-caption">Older - </span>
        <span class="article-nav-title">
          
            HTTP2 Server PushとService Workerを使ったレスポンス改善
          
        </span>
        
      </a>
    
  </div>
</nav>

  
</article>


<section class="comments" id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      
    </main>
    <footer id="footer" role="contentinfo">
  
  <div class="footer-cotent">
    <small>&copy; 2019 kazu69</small>
    <span class="generator">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
  </div>
</footer>
    
<script>
  var disqus_shortname = '69log';
  
  var disqus_url = 'http://blog.kazu69.net/2017/02/19/learned_consul_again/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</body>
</html>