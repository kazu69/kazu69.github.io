<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Consulを再度学んだ | 69log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="consulを少し触ったままだったので、ちゃんと学んでみた。と言っても一通り触ったくらいであるが。
あらためて試すにあたり、Official Consul Docker Imageを使用してクラスタを構成した。">
<meta property="og:type" content="article">
<meta property="og:title" content="Consulを再度学んだ">
<meta property="og:url" content="http://blog.kazu69.net/2017/02/19/learned_consul_again/index.html">
<meta property="og:site_name" content="69log">
<meta property="og:description" content="consulを少し触ったままだったので、ちゃんと学んでみた。と言っても一通り触ったくらいであるが。
あらためて試すにあたり、Official Consul Docker Imageを使用してクラスタを構成した。">
<meta property="og:updated_time" content="2017-02-27T13:51:57.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Consulを再度学んだ">
<meta name="twitter:description" content="consulを少し触ったままだったので、ちゃんと学んでみた。と言っても一通り触ったくらいであるが。
あらためて試すにあたり、Official Consul Docker Imageを使用してクラスタを構成した。">
  
    <link rel="alternative" href="/atom.xml" title="69log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-9196861-14', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
    <header role="header">
  <div class="header cf">
    <div class="title-content">
      <h1>
        <a href="/">69log</a>
      </h1>
      
        <h2>
          <a href="/">福岡でwebの仕事をしています</a>
        </h2>
      
    </div>

    <div class="nav-content cf">
      <nav>
        
          <a href="/" class="nav-link nav-home">home</a>
        
          <a href="/archives" class="nav-link nav-archives">archives</a>
        
        
          <a href="/atom.xml" title="RSS Feed" class="icon nav-link nav-feed"></a>
        
      </nav>
      <div class="header-search">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://blog.kazu69.net"></form>
      </div>
    </div>
  </div>
</header>

    <main role="main" id="main">
      <section><article id="post-learned_consul_again" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    
      
  
    <h1 class="article-title" itemprop="name">
      Consulを再度学んだ
    </h1>
  

    
    <div class="article-meta clr">
      <time datetime="2017-02-19T14:34:45.000Z" itemprop="datePublished">2017-02-19</time>

      
  <div class="article-category">
    <a class="article-category-link" href="/categories/memo/">memo</a>
  </div>


    </div>
  </header>

  <div class="article-entry" itemprop="articleBody">
    <div class="article-gallery">
      
    </div>
    
      <p>consulを少し触ったままだったので、ちゃんと学んでみた。<br>と言っても一通り触ったくらいであるが。</p>
<p>あらためて試すにあたり、<a href="https://hub.docker.com/_/consul/" target="_blank" rel="external">Official Consul Docker Image</a>を使用してクラスタを構成した。</p>
<a id="more"></a>
<h2 id="counsulのおさらい"><a href="#counsulのおさらい" class="headerlink" title="counsulのおさらい"></a>counsulのおさらい</h2><p>consulをざっくりとおさらい。<br>複数のサーバーをクラスタ化して、オーケストレーションするツール。<br>クラスタ内のサーバー同士をDNSインターフェイスを通してIPベース相互検出し(Discovery)、健全性を確認し(Health Check)、特定のサーバーへのトラフィックを回避する(Load Balancing)を行う。</p>
<p>RESTベースの外部API(HTTP API)を提供しており、サーバー情報はキーバリュースストアで保持されている。</p>
<h2 id="dockerでクラスタ構成を作る"><a href="#dockerでクラスタ構成を作る" class="headerlink" title="dockerでクラスタ構成を作る"></a>dockerでクラスタ構成を作る</h2><p>consulはサーバとクライアントという2つのコンポーネントで構成され、いずれかの状態で起動する必要がある。<br>クライアントモードでは各サーバーと通信をする。<br>サーバーモードでは奇数台で構成されることを期待されていて、それぞれがGossip Protocolで通信し、Raftアルゴリズムに基づいてリーダーを選出する。</p>
<p>今回はdockerを使って以下のような構成を使っておさらいする</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># server</div><div class="line">consul --</div><div class="line">         `- consul1 (leader) 172.16.238.10</div><div class="line">         `- consul2          172.16.238.11</div><div class="line">         `- consul3          172.16.238.12</div><div class="line"># agent</div><div class="line">nginx  --</div><div class="line">         `- nginx1           172.16.238.13</div><div class="line">         `- nginx2           172.16.238.14</div><div class="line">         `- nginx3           172.16.238.15</div></pre></td></tr></table></figure>
<p>ということでserver 3コンテナを起動してみる。</p>
<p>ちなみにconsulでは次のポートをデフォルトで使用する。</p>
<table>
<thead>
<tr>
<th>機能</th>
<th>protocol</th>
<th>port</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>Server RPC</td>
<td>TCP</td>
<td>8300</td>
<td>他のAgentからのリクエストを受付る</td>
</tr>
<tr>
<td>Serf LAN</td>
<td>TCP and UDP</td>
<td>8301</td>
<td>LAN上のゴシッププロトコル。すべてのAgentが使用する。</td>
</tr>
<tr>
<td>Serf WAN</td>
<td>TCP and UDP</td>
<td>8302</td>
<td>WAN上のゴシッププロトコル。他のサーバーとの通信に使用。</td>
</tr>
<tr>
<td>CLI RPC</td>
<td>TCP</td>
<td>8400</td>
<td>CLIからの入力を処理する。すべてのAgentが使用する。</td>
</tr>
<tr>
<td>HTTP API</td>
<td>TCP</td>
<td>8500</td>
<td>クライアントがHTTP API を受付る</td>
</tr>
<tr>
<td>DNS Interface</td>
<td>TCP and UDP</td>
<td>8600</td>
<td>DNSクエリを解決する</td>
</tr>
</tbody>
</table>
<p>今回は外からも利用するので一つだけ書くポートをフォワードしておく。</p>
<h2 id="リーダー選出"><a href="#リーダー選出" class="headerlink" title="リーダー選出"></a>リーダー選出</h2><p>指定数以上のサーバーが起動したことで、リーダーが選出されていることを確認する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># リーダーのnodeの情報取得</span></div><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/status/leader | jq .</div><div class="line"><span class="string">"172.16.238.10:8300"</span></div><div class="line"></div><div class="line"><span class="comment"># agentのnode情報取得</span></div><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/status/peers | jq .</div><div class="line">[</div><div class="line">  <span class="string">"172.16.238.10:8300"</span>,</div><div class="line">  <span class="string">"172.16.238.12:8300"</span>,</div><div class="line">  <span class="string">"172.16.238.11:8300"</span></div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="agentの追加"><a href="#agentの追加" class="headerlink" title="agentの追加"></a>agentの追加</h3><p>3台起動してるnginxコンテナをagentモードでクラスタに追加する。<br>(追加時に合わせて幾つか死活監視を試せるようにしている)</p>
<p>起動しているコンテナは以下の状態</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS              PORTS                                                                                                                                       NAMES</div><div class="line">c48eb5e1c99a        learnconsul_nginx2   <span class="string">"nginx -g 'daemon ..."</span>   24 hours ago        Up 24 hours         443/tcp, 0.0.0.0:8000-&gt;80/tcp                                                                                                               nginx2</div><div class="line">1bd432bd0b98        consul:latest        <span class="string">"docker-entrypoint..."</span>   24 hours ago        Up 24 hours         8300-8302/tcp, 8400/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                                                        consul2</div><div class="line">7917ff526a10        learnconsul_nginx1   <span class="string">"nginx -g 'daemon ..."</span>   24 hours ago        Up 24 hours         443/tcp, 0.0.0.0:8080-&gt;80/tcp                                                                                                               nginx1</div><div class="line">f72330ed0182        consul:latest        <span class="string">"docker-entrypoint..."</span>   24 hours ago        Up 24 hours         8300-8302/tcp, 8400/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                                                        consul3</div><div class="line">5c40e078481e        learnconsul_nginx3   <span class="string">"nginx -g 'daemon ..."</span>   24 hours ago        Up 24 hours         443/tcp, 0.0.0.0:8888-&gt;80/tcp                                                                                                               nginx3</div><div class="line">f7270595eda4        consul:latest        <span class="string">"docker-entrypoint..."</span>   24 hours ago        Up 24 hours         0.0.0.0:8300-8302-&gt;8300-8302/tcp, 0.0.0.0:8400-&gt;8400/tcp, 8301-8302/udp, 0.0.0.0:8500-&gt;8500/tcp, 8600/udp, 8600/tcp, 0.0.0.0:8600-&gt;53/udp   consul1</div></pre></td></tr></table></figure>
<p>nodeを追加していく</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># configファイルをコンテナにコピー</span></div><div class="line">docker cp config/nginx1 nginx1:/etc/consul.d</div><div class="line"><span class="comment"># clusterにjoinする</span></div><div class="line">docker <span class="built_in">exec</span> <span class="_">-d</span> -t nginx1 consul agent -config-file=/etc/consul.d/nginx1</div><div class="line"><span class="comment"># ttl health check用のスクリプトを起動</span></div><div class="line">docker <span class="built_in">exec</span> <span class="_">-d</span> -t nginx1 bash -c <span class="string">'./http_request nginx1'</span></div><div class="line"> </div><div class="line">consul1    |     2017/01/25 07:50:51 [INFO] serf: EventMemberJoin: nginx1 172.16.238.13</div><div class="line">consul1    |     2017/01/25 07:50:51 [INFO] consul: member <span class="string">'nginx1'</span> joined, marking health alive</div><div class="line">consul2    |     2017/01/25 07:50:51 [INFO] serf: EventMemberJoin: nginx1 172.16.238.13</div><div class="line">consul3    |     2017/01/25 07:50:51 [INFO] serf: EventMemberJoin: nginx1 172.16.238.13</div><div class="line"> </div><div class="line"><span class="comment"># 以下nginx1と同じ処理を行う</span></div><div class="line"> </div><div class="line"><span class="comment"># nginx2</span></div><div class="line">docker cp config/nginx2 nginx2:/etc/consul.d</div><div class="line">docker <span class="built_in">exec</span> <span class="_">-d</span> -t nginx2 consul agent -config-file=/etc/consul.d/nginx2</div><div class="line">docker <span class="built_in">exec</span> <span class="_">-d</span> -t nginx2 bash -c <span class="string">'./http_request nginx2'</span></div><div class="line"> </div><div class="line">consul1    |     2017/01/25 07:51:31 [INFO] serf: EventMemberJoin: nginx2 172.16.238.14</div><div class="line">consul1    |     2017/01/25 07:51:31 [INFO] consul: member <span class="string">'nginx2'</span> joined, marking health alive</div><div class="line">consul2    |     2017/01/25 07:51:31 [INFO] serf: EventMemberJoin: nginx2 172.16.238.14</div><div class="line">consul3    |     2017/01/25 07:51:31 [INFO] serf: EventMemberJoin: nginx2 172.16.238.14</div><div class="line"> </div><div class="line"><span class="comment"># nginx3</span></div><div class="line">docker cp config/nginx3 nginx3:/etc/consul.d</div><div class="line">docker <span class="built_in">exec</span> <span class="_">-d</span> -t nginx3 consul agent -config-file=/etc/consul.d/nginx3</div><div class="line">docker <span class="built_in">exec</span> <span class="_">-d</span> -t nginx3 bash -c <span class="string">'./http_request nginx3'</span></div><div class="line"> </div><div class="line">consul1    |     2017/01/25 07:52:06 [INFO] serf: EventMemberJoin: nginx3 172.16.238.15</div><div class="line">consul1    |     2017/01/25 07:52:06 [INFO] consul: member <span class="string">'nginx3'</span> joined, marking health alive</div><div class="line">consul2    |     2017/01/25 07:52:06 [INFO] serf: EventMemberJoin: nginx3 172.16.238.15</div><div class="line">consul3    |     2017/01/25 07:52:06 [INFO] serf: EventMemberJoin: nginx3 172.16.238.15</div></pre></td></tr></table></figure>
<p>追加されていることをapiを通じて確認する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ローカルエージェント(consul1)で既知のノードを返します</span></div><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/catalog/nodes | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"consul1"</span>,</div><div class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.10"</span>,</div><div class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.10"</span>,</div><div class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.10"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Meta"</span>: &#123;&#125;,</div><div class="line">    <span class="string">"CreateIndex"</span>: 5,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 9</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"consul2"</span>,</div><div class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.11"</span>,</div><div class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.11"</span>,</div><div class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.11"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Meta"</span>: &#123;&#125;,</div><div class="line">    <span class="string">"CreateIndex"</span>: 4,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 20</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</div><div class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.12"</span>,</div><div class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.12"</span>,</div><div class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.12"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Meta"</span>: &#123;&#125;,</div><div class="line">    <span class="string">"CreateIndex"</span>: 6,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 8</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.13"</span>,</div><div class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.13"</span>,</div><div class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.13"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Meta"</span>: null,</div><div class="line">    <span class="string">"CreateIndex"</span>: 28,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 29</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</div><div class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.14"</span>,</div><div class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.14"</span>,</div><div class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.14"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Meta"</span>: null,</div><div class="line">    <span class="string">"CreateIndex"</span>: 119,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 120</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</div><div class="line">    <span class="string">"Address"</span>: <span class="string">"172.16.238.15"</span>,</div><div class="line">    <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">      <span class="string">"lan"</span>: <span class="string">"172.16.238.15"</span>,</div><div class="line">      <span class="string">"wan"</span>: <span class="string">"172.16.238.15"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Meta"</span>: null,</div><div class="line">    <span class="string">"CreateIndex"</span>: 132,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 134</div><div class="line">  &#125;</div><div class="line">]</div><div class="line"> </div><div class="line"><span class="comment"># ローカルエージェント(consul1)で登録された全ての service を返す</span></div><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/agent/services | jq .</div><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="string">"consul"</span>: &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">"consul"</span>,</div><div class="line">    <span class="string">"Service"</span>: <span class="string">"consul"</span>,</div><div class="line">    <span class="string">"Tags"</span>: [],</div><div class="line">    <span class="string">"Address"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Port"</span>: 8300,</div><div class="line">    <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 0,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 0</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment"># ローカルエージェント(consul1) のserf エージェントが見えているメンバを返す</span></div><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/agent/members | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.13"</span>,</div><div class="line">    <span class="string">"Port"</span>: 8301,</div><div class="line">    <span class="string">"Tags"</span>: &#123;</div><div class="line">      <span class="string">"build"</span>: <span class="string">"0.7.2:'a9afa0c"</span>,</div><div class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</div><div class="line">      <span class="string">"role"</span>: <span class="string">"node"</span>,</div><div class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</div><div class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</div><div class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Status"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMin"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMax"</span>: 5,</div><div class="line">    <span class="string">"ProtocolCur"</span>: 2,</div><div class="line">    <span class="string">"DelegateMin"</span>: 2,</div><div class="line">    <span class="string">"DelegateMax"</span>: 4,</div><div class="line">    <span class="string">"DelegateCur"</span>: 4</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"nginx2"</span>,</div><div class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.14"</span>,</div><div class="line">    <span class="string">"Port"</span>: 8301,</div><div class="line">    <span class="string">"Tags"</span>: &#123;</div><div class="line">      <span class="string">"build"</span>: <span class="string">"0.7.2:'a9afa0c"</span>,</div><div class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</div><div class="line">      <span class="string">"role"</span>: <span class="string">"node"</span>,</div><div class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</div><div class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</div><div class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Status"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMin"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMax"</span>: 5,</div><div class="line">    <span class="string">"ProtocolCur"</span>: 2,</div><div class="line">    <span class="string">"DelegateMin"</span>: 2,</div><div class="line">    <span class="string">"DelegateMax"</span>: 4,</div><div class="line">    <span class="string">"DelegateCur"</span>: 4</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"nginx3"</span>,</div><div class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.15"</span>,</div><div class="line">    <span class="string">"Port"</span>: 8301,</div><div class="line">    <span class="string">"Tags"</span>: &#123;</div><div class="line">      <span class="string">"build"</span>: <span class="string">"0.7.2:'a9afa0c"</span>,</div><div class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</div><div class="line">      <span class="string">"role"</span>: <span class="string">"node"</span>,</div><div class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</div><div class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</div><div class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Status"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMin"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMax"</span>: 5,</div><div class="line">    <span class="string">"ProtocolCur"</span>: 2,</div><div class="line">    <span class="string">"DelegateMin"</span>: 2,</div><div class="line">    <span class="string">"DelegateMax"</span>: 4,</div><div class="line">    <span class="string">"DelegateCur"</span>: 4</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"consul1"</span>,</div><div class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.10"</span>,</div><div class="line">    <span class="string">"Port"</span>: 8301,</div><div class="line">    <span class="string">"Tags"</span>: &#123;</div><div class="line">      <span class="string">"build"</span>: <span class="string">"0.7.5:'21f2d5a"</span>,</div><div class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</div><div class="line">      <span class="string">"expect"</span>: <span class="string">"3"</span>,</div><div class="line">      <span class="string">"id"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">      <span class="string">"port"</span>: <span class="string">"8300"</span>,</div><div class="line">      <span class="string">"role"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</div><div class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</div><div class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Status"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMin"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMax"</span>: 5,</div><div class="line">    <span class="string">"ProtocolCur"</span>: 2,</div><div class="line">    <span class="string">"DelegateMin"</span>: 2,</div><div class="line">    <span class="string">"DelegateMax"</span>: 5,</div><div class="line">    <span class="string">"DelegateCur"</span>: 4</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"consul3"</span>,</div><div class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.12"</span>,</div><div class="line">    <span class="string">"Port"</span>: 8301,</div><div class="line">    <span class="string">"Tags"</span>: &#123;</div><div class="line">      <span class="string">"build"</span>: <span class="string">"0.7.5:'21f2d5a"</span>,</div><div class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</div><div class="line">      <span class="string">"id"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">      <span class="string">"port"</span>: <span class="string">"8300"</span>,</div><div class="line">      <span class="string">"role"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</div><div class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</div><div class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Status"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMin"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMax"</span>: 5,</div><div class="line">    <span class="string">"ProtocolCur"</span>: 2,</div><div class="line">    <span class="string">"DelegateMin"</span>: 2,</div><div class="line">    <span class="string">"DelegateMax"</span>: 5,</div><div class="line">    <span class="string">"DelegateCur"</span>: 4</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"consul2"</span>,</div><div class="line">    <span class="string">"Addr"</span>: <span class="string">"172.16.238.11"</span>,</div><div class="line">    <span class="string">"Port"</span>: 8301,</div><div class="line">    <span class="string">"Tags"</span>: &#123;</div><div class="line">      <span class="string">"build"</span>: <span class="string">"0.7.5:'21f2d5a"</span>,</div><div class="line">      <span class="string">"dc"</span>: <span class="string">"dc1"</span>,</div><div class="line">      <span class="string">"id"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">      <span class="string">"port"</span>: <span class="string">"8300"</span>,</div><div class="line">      <span class="string">"role"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"vsn"</span>: <span class="string">"2"</span>,</div><div class="line">      <span class="string">"vsn_max"</span>: <span class="string">"3"</span>,</div><div class="line">      <span class="string">"vsn_min"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Status"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMin"</span>: 1,</div><div class="line">    <span class="string">"ProtocolMax"</span>: 5,</div><div class="line">    <span class="string">"ProtocolCur"</span>: 2,</div><div class="line">    <span class="string">"DelegateMin"</span>: 2,</div><div class="line">    <span class="string">"DelegateMax"</span>: 5,</div><div class="line">    <span class="string">"DelegateCur"</span>: 4</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service consulのhealth check</span></div><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/health/service/consul | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">      <span class="string">"Node"</span>: <span class="string">"consul1"</span>,</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.10"</span>,</div><div class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.10"</span>,</div><div class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.10"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="string">"Meta"</span>: &#123;&#125;,</div><div class="line">      <span class="string">"CreateIndex"</span>: 5,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 9</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Service"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"Service"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"Tags"</span>: [],</div><div class="line">      <span class="string">"Address"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"Port"</span>: 8300,</div><div class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="string">"CreateIndex"</span>: 5,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 9</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Checks"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"consul1"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 5,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 5</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">      <span class="string">"Node"</span>: <span class="string">"consul2"</span>,</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.11"</span>,</div><div class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.11"</span>,</div><div class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.11"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="string">"Meta"</span>: &#123;&#125;,</div><div class="line">      <span class="string">"CreateIndex"</span>: 4,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 35</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Service"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"Service"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"Tags"</span>: [],</div><div class="line">      <span class="string">"Address"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"Port"</span>: 8300,</div><div class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="string">"CreateIndex"</span>: 4,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 35</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Checks"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"consul2"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 8,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 8</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"e8ded508-98bb-4f9b-b0a2-ea872a0361d6"</span>,</div><div class="line">      <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.12"</span>,</div><div class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.12"</span>,</div><div class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.12"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="string">"Meta"</span>: &#123;&#125;,</div><div class="line">      <span class="string">"CreateIndex"</span>: 6,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 32</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Service"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"Service"</span>: <span class="string">"consul"</span>,</div><div class="line">      <span class="string">"Tags"</span>: [],</div><div class="line">      <span class="string">"Address"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"Port"</span>: 8300,</div><div class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="string">"CreateIndex"</span>: 6,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 32</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Checks"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 7,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 7</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="health-check-死活監視-について"><a href="#health-check-死活監視-について" class="headerlink" title="health check(死活監視)について"></a>health check(死活監視)について</h3><p>consulのhealth checkには次の種類のものがある。</p>
<table>
<thead>
<tr>
<th>check</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>Script + Interval</td>
<td>Exit code 0でpassing、Exit code 1でWarning、それ以外でcriticalとなるスクリプトを実行する</td>
</tr>
<tr>
<td>HTTP + Interval</td>
<td>curlなどでのHTTPリクエスト。2xxステータスでpassing。429 Too Many Requestsでwarning。それ以外はcritical。</td>
</tr>
<tr>
<td>TCP + Interval</td>
<td>指定ホストにTCPで接続を試みる。接続成功でpassing、それ以外はciritcalとなる。</td>
</tr>
<tr>
<td>Time to Live (TTL)</td>
<td>アプリケーションが自身の状態をチェックして通知する。通知状態はTTLの間保持される。</td>
</tr>
<tr>
<td>Docker + Interval</td>
<td>DockerコンテナにHTTPまたはSocket通信し、適切な終了コードかをチェックする</td>
</tr>
</tbody>
</table>
<p>今回は以下の機能を試す。</p>
<ul>
<li>HTTP + Interval</li>
<li>TCP + Interval</li>
<li>Time to Live (TTL)</li>
</ul>
<p>ちなみにTime to Liveはちょっとわかりにくいが、自身のconsul http apiを実行する。<br>例えばpass状態を送る場合は <a href="http://localhost:8500/v1/agent/check/pass/{CHECK_ID}" target="_blank" rel="external">http://localhost:8500/v1/agent/check/pass/{CHECK_ID}</a> にリクエストする。</p>
<p>今回のhealth checkの設定は以下のようにしている。<br>(すでにclusterにjoinするときに設定は行っている)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// nginx1の場合</span></div><div class="line"></div><div class="line">&#123;</div><div class="line"><span class="string">"checks"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">      <span class="string">"http"</span>: <span class="string">"http://localhost:80"</span>,</div><div class="line">      <span class="string">"interval"</span>: <span class="string">"10s"</span>,</div><div class="line">      <span class="string">"timeout"</span>: <span class="string">"1s"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="string">"id"</span>: <span class="string">"nginx1"</span>,</div><div class="line">      <span class="string">"name"</span>: <span class="string">"Nginx Status"</span>,</div><div class="line">      <span class="string">"ttl"</span>: <span class="string">"30s"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="string">"name"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">      <span class="string">"tcp"</span>: <span class="string">"172.16.238.13:80"</span>,</div><div class="line">      <span class="string">"interval"</span>: <span class="string">"10s"</span>,</div><div class="line">      <span class="string">"timeout"</span>: <span class="string">"1s"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>service(nginx1、nginx2、nginx3)ごとのstatusを取得してみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service nginxのhealth check</span></div><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/health/service/proxy | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.13"</span>,</div><div class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.13"</span>,</div><div class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.13"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="string">"Meta"</span>: null,</div><div class="line">      <span class="string">"CreateIndex"</span>: 12,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 13</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Service"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"proxy"</span>,</div><div class="line">      <span class="string">"Service"</span>: <span class="string">"proxy"</span>,</div><div class="line">      <span class="string">"Tags"</span>: [</div><div class="line">        <span class="string">"nginx"</span></div><div class="line">      ],</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.13"</span>,</div><div class="line">      <span class="string">"Port"</span>: 80,</div><div class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="string">"CreateIndex"</span>: 13,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 13</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Checks"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"HTTP GET http://172.16.238.13: 200 OK Output: &lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body &#123;\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    &#125;\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 14,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 17</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"nginx1"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 15,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 227</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 12,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 12</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.13:80: Success"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 16,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 18</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.14"</span>,</div><div class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.14"</span>,</div><div class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.14"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="string">"Meta"</span>: null,</div><div class="line">      <span class="string">"CreateIndex"</span>: 22,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 25</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Service"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"proxy"</span>,</div><div class="line">      <span class="string">"Service"</span>: <span class="string">"proxy"</span>,</div><div class="line">      <span class="string">"Tags"</span>: [</div><div class="line">        <span class="string">"nginx"</span></div><div class="line">      ],</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.14"</span>,</div><div class="line">      <span class="string">"Port"</span>: 80,</div><div class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="string">"CreateIndex"</span>: 25,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 25</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Checks"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"HTTP GET http://172.16.238.14: 200 OK Output: &lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body &#123;\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    &#125;\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 26,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 30</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"nginx2"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 27,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 223</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 22,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 22</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx2"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.14:80: Success"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 28,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 29</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.15"</span>,</div><div class="line">      <span class="string">"TaggedAddresses"</span>: &#123;</div><div class="line">        <span class="string">"lan"</span>: <span class="string">"172.16.238.15"</span>,</div><div class="line">        <span class="string">"wan"</span>: <span class="string">"172.16.238.15"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="string">"Meta"</span>: null,</div><div class="line">      <span class="string">"CreateIndex"</span>: 37,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 38</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Service"</span>: &#123;</div><div class="line">      <span class="string">"ID"</span>: <span class="string">"proxy"</span>,</div><div class="line">      <span class="string">"Service"</span>: <span class="string">"proxy"</span>,</div><div class="line">      <span class="string">"Tags"</span>: [</div><div class="line">        <span class="string">"nginx"</span></div><div class="line">      ],</div><div class="line">      <span class="string">"Address"</span>: <span class="string">"172.16.238.15"</span>,</div><div class="line">      <span class="string">"Port"</span>: 80,</div><div class="line">      <span class="string">"EnableTagOverride"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="string">"CreateIndex"</span>: 38,</div><div class="line">      <span class="string">"ModifyIndex"</span>: 38</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Checks"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"HTTP GET http://172.16.238.15: 200 OK Output: &lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body &#123;\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    &#125;\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 41,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 42</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"nginx3"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 39,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 228</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 37,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 37</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"Node"</span>: <span class="string">"nginx3"</span>,</div><div class="line">        <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">        <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">        <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.14:80: Success"</span>,</div><div class="line">        <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"CreateIndex"</span>: 40,</div><div class="line">        <span class="string">"ModifyIndex"</span>: 44</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>consul serverのnodeを一つダウンしてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker stop consul3</div><div class="line">consul3</div></pre></td></tr></table></figure>
<p>consul3の状態を確認する</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/health/node/consul3 | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"Agent not live or unreachable"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 7,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 748</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>consul3 を復帰させる</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker start consul3</div><div class="line">consul3</div></pre></td></tr></table></figure>
<p>再び状態を確認してみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/health/node/consul3 | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"consul3"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 7,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 800</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>nginx1のnodeのhttpチェックをcriticalな状態にしてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> nginx1 mv /usr/share/nginx/html/index.html /usr/share/nginx/html/index.txt</div><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/health/node/nginx1 | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"HTTP GET http://localhost:80: 403 Forbidden Output: &lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\r\n&lt;body bgcolor=\"white\"&gt;\r\n&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx/1.11.10&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 614,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 803</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 612,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 806</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 610,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 610</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.13:80: Success"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 613,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 613</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>apiからciriticalなものだけ取得してみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/health/state/critical | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"HTTP GET http://localhost:80: 403 Forbidden Output: &lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\r\n&lt;body bgcolor=\"white\"&gt;\r\n&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx/1.11.10&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 614,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 803</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="メンテナンスモード"><a href="#メンテナンスモード" class="headerlink" title="メンテナンスモード"></a>メンテナンスモード</h3><p>当たり前ではなるが、nodeをメンテナス状態にできる。<br>nginx1をメンテナンスモードにする。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it nginx1 /bin/bash</div><div class="line"></div><div class="line"><span class="comment"># maintenance modeをenableにして、理由にtestとする</span></div><div class="line">consul maint -reason <span class="built_in">test</span> -enable</div><div class="line">Node maintenance is now enabled</div><div class="line"></div><div class="line"><span class="comment"># maintenance の状態を確認</span></div><div class="line">consul maint</div><div class="line">Node:</div><div class="line">  Name:   nginx1</div><div class="line">  Reason: <span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>nginx1の状態を確認する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">curl <span class="_">-s</span> http://localhost:8500/v1/health/node/nginx1 | jq .</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"_node_maintenance"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"Node Maintenance Mode"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">"test"</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 894,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 894</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"HTTP Nginx on port 80"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"HTTP GET http://localhost:80: 200 OK Output: "</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 614,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 869</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"Nginx Status"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 612,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 928</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"Agent alive and reachable"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 610,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 610</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"SSH TCP on port 80"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"passing"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"TCP connect 172.16.238.13:80: Success"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"CreateIndex"</span>: 613,</div><div class="line">    <span class="string">"ModifyIndex"</span>: 613</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>メンテナンスモードを解除する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># maintenance modeをdisableにする</span></div><div class="line">consul maint -disable</div><div class="line">Node maintenance is now disabled</div><div class="line"></div><div class="line">consul maint</div><div class="line"><span class="comment"># なし</span></div></pre></td></tr></table></figure>
<h3 id="event処理"><a href="#event処理" class="headerlink" title="event処理"></a>event処理</h3><p>イベントを監視して、発火時に任意の処理を実行することができる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># testイベントをwatchする</span></div><div class="line">docker <span class="built_in">exec</span> -it consule1 /bin/sh</div><div class="line">consul watch -type=event -name=<span class="built_in">test</span> <span class="built_in">echo</span> <span class="string">"test"</span></div><div class="line"></div><div class="line"><span class="comment"># testイベントを発行</span></div><div class="line">docker <span class="built_in">exec</span> -it nginx1 /bin/bash</div><div class="line"></div><div class="line"><span class="comment"># consul1</span></div><div class="line"><span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>watchコマンドで状態が変化した際に特定の処理をしてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it consule1 /bin/sh</div><div class="line">consul watch -type=checks -state=critical <span class="string">"jq ."</span></div><div class="line">[]</div><div class="line"> </div><div class="line"><span class="comment"># nginx1を落とす</span></div><div class="line">docker stop nginx1</div><div class="line"> </div><div class="line"><span class="comment"># criticalが表示される</span></div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"Node"</span>: <span class="string">"nginx1"</span>,</div><div class="line">    <span class="string">"CheckID"</span>: <span class="string">"serfHealth"</span>,</div><div class="line">    <span class="string">"Name"</span>: <span class="string">"Serf Health Status"</span>,</div><div class="line">    <span class="string">"Status"</span>: <span class="string">"critical"</span>,</div><div class="line">    <span class="string">"Notes"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"Output"</span>: <span class="string">"Agent not live or unreachable"</span>,</div><div class="line">    <span class="string">"ServiceID"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"ServiceName"</span>: <span class="string">""</span></div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="consul-templateを試してみる"><a href="#consul-templateを試してみる" class="headerlink" title="consul-templateを試してみる"></a>consul-templateを試してみる</h3><p><a href="https://github.com/hashicorp/consul-template" target="_blank" rel="external">consul-template</a>も試しておく。<br>consul-templateは特定のイベントに応じて、登録しているtemplateからファイルを生成することができる。<br>イベントを監視して、特定のイベントが発火すると登録しているtemplateからファイルを再生成する感じである。</p>
<p>consul-templateで監視できるイベントは</p>
<ul>
<li>datacenter(detacenterの)</li>
<li>file(fileの変更)</li>
<li>key(ストアのkey変更・存在)</li>
<li>ls(kvストアの最上位のkey)</li>
<li>node</li>
<li>secret</li>
<li>service</li>
<li>tree(kvストアのkvペア)</li>
</ul>
<p>例えば、次のようなnodeが追加されるたびにhost名とipを記載したファイルが出力されるもので試してみる。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; range nodes &#125;&#125;</div><div class="line"># &#123;&#123;.Node&#125;&#125;</div><div class="line">&#123;&#123; .Address &#125;&#125; &#123;&#123;.Node&#125;&#125;</div><div class="line">&#123;&#123; end &#125;&#125;</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it nginx1 /bin/bash</div><div class="line"> </div><div class="line"><span class="comment"># -dry でdry run</span></div><div class="line">consul-template -consul-addr 127.0.0.1:8500 -template <span class="string">"/etc/consul-template/config.d/templates/hosts.ctmpl:/hosts"</span> -dry</div><div class="line"> </div><div class="line">&gt; /hosts</div><div class="line"> </div><div class="line"><span class="comment"># consul1</span></div><div class="line">172.16.238.10 consul1</div><div class="line"> </div><div class="line"><span class="comment"># consul2</span></div><div class="line">172.16.238.11 consul2</div><div class="line"> </div><div class="line"><span class="comment"># consul3</span></div><div class="line">172.16.238.12 consul3</div><div class="line"> </div><div class="line"><span class="comment"># nginx1</span></div><div class="line">172.16.238.13 nginx1</div></pre></td></tr></table></figure>
<p>node nginx2を追加する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&gt; /hosts</div><div class="line"> </div><div class="line"><span class="comment"># consul1</span></div><div class="line">172.16.238.10 consul1</div><div class="line"> </div><div class="line"><span class="comment"># consul2</span></div><div class="line">172.16.238.11 consul2</div><div class="line"> </div><div class="line"><span class="comment"># consul3</span></div><div class="line">172.16.238.12 consul3</div><div class="line"> </div><div class="line"><span class="comment"># nginx1</span></div><div class="line">172.16.238.13 nginx1</div><div class="line"> </div><div class="line"><span class="comment"># nginx2</span></div><div class="line">172.16.238.14 nginx2</div></pre></td></tr></table></figure>
<p>テンプレートが更新されている。</p>
<h3 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h3><p>おさらいとして、今回はdockerの公式イメージでクラスタを構成してみた。<br>consulによるクラスタ構成を以前より意識できた感がある。</p>
<h3 id="repository"><a href="#repository" class="headerlink" title="repository"></a>repository</h3><p><a href="https://github.com/kazu69/docker-consul-example" target="_blank" rel="external">docker-consul-example</a></p>

    
  </div>

  
    <footer class="article-footer">

      
        <aside class="google-adsence">
          
<!-- Google Adsence -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-4054575508733221"
   data-ad-slot="9493597992"
   data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- End Google Adsence -->


        </aside>
      

      <div class="share_content">
  <div class="hatena_sharebox">
    
      <a href="http://b.hatena.ne.jp/entry/blog.kazu69.net/2017/02/19/learned_consul_again/" class="hatena-bookmark-button" data-hatena-bookmark-title="Consulを再度学んだ" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  </div>
  
    <div class="addthis addthis_toolbox addthis_default_style">
      
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
      
      
        <a class="addthis_button_tweet"></a>
      
      
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
      
      
      <!-- <a class="addthis_counter addthis_pill_style"></a> -->
    </div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55a4f49a45ced975"></script>
  
</div>

      
        <a href="http://blog.kazu69.net/2017/02/19/learned_consul_again/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  

  
    
<nav id="article-nav">
  <div class="article-nav">
    
      <a href="/2017/03/23/http-request-using-cors/" id="article-nav-newer" class="article-nav-link article-nav-link-newer">
        <span class="article-nav-caption">Newer - </span>
        <span class="article-nav-title">
          
            Cross-Origin Resource Sharing(CORS)を使用したHTTPリクエスト
          
        </span>
      </a>
    
    
      <a href="/2017/01/28/response_improvement_using_http2_server_push_service_worke/" id="article-nav-older" class="article-nav-link article-nav-link-older">
        <span class="article-nav-caption">Older - </span>
        <span class="article-nav-title">
          
            HTTP2 Server PushとService Workerを使ったレスポンス改善
          
        </span>
        </span>
      </a>
    
  </div>
</nav>

  
</article>


<section class="comments" id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      
    </main>
    <footer id="footer" role="contentinfo">
  
  <div class="footer-cotent">
    <small>&copy; 2017 kazu69</small>
    <span class="generator">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
  </div>
</footer>
    
<script>
  var disqus_shortname = '69log';
  
  var disqus_url = 'http://blog.kazu69.net/2017/02/19/learned_consul_again/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</body>
</html>