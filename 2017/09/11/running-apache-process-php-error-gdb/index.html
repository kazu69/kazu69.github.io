<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>稼働中のapacheプロセスやphpエラーgdbで追う | 69log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="稼働中のサービスにおいてapacheのプロセスが閾値を超える事象が頻発したり、phpのバグを踏んだりした際に。なにが原因なのか究明のために行ったときの備忘録。">
<meta property="og:type" content="article">
<meta property="og:title" content="稼働中のapacheプロセスやphpエラーgdbで追う">
<meta property="og:url" content="http://blog.kazu69.net/2017/09/11/running-apache-process-php-error-gdb/index.html">
<meta property="og:site_name" content="69log">
<meta property="og:description" content="稼働中のサービスにおいてapacheのプロセスが閾値を超える事象が頻発したり、phpのバグを踏んだりした際に。なにが原因なのか究明のために行ったときの備忘録。">
<meta property="og:locale" content="ja">
<meta property="og:updated_time" content="2017-09-18T23:31:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="稼働中のapacheプロセスやphpエラーgdbで追う">
<meta name="twitter:description" content="稼働中のサービスにおいてapacheのプロセスが閾値を超える事象が頻発したり、phpのバグを踏んだりした際に。なにが原因なのか究明のために行ったときの備忘録。">
  
    <link rel="alternative" href="/atom.xml" title="69log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-9196861-14', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head></html>
<body>
    <header role="header">
  <div class="header cf">
    <div class="title-content">
      <h1>
        <a href="/">69log</a>
      </h1>
      
        <h2>
          <a href="/">福岡でwebの仕事をしています</a>
        </h2>
      
    </div>

    <div class="nav-content cf">
      <nav>
        
          <a href="/" class="nav-link nav-home">home</a>
        
          <a href="/archives" class="nav-link nav-archives">archives</a>
        
        
          <a href="/atom.xml" title="RSS Feed" class="icon nav-link nav-feed"></a>
        
      </nav>
      <div class="header-search">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://blog.kazu69.net"></form>
      </div>
    </div>
  </div>
</header>

    <main role="main" id="main">
      <section><article id="post-running-apache-process-php-error-gdb" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    
      
  
    <h1 class="article-title" itemprop="name">
      稼働中のapacheプロセスやphpエラーgdbで追う
    </h1>
  

    
    <div class="article-meta clr">
      <time datetime="2017-09-11T01:40:10.000Z" itemprop="datePublished">2017-09-11</time>

      
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>


    </div>
  </header>

  <div class="article-entry" itemprop="articleBody">
    <div class="article-gallery">
      
    </div>
    
      <p>稼働中のサービスにおいてapacheのプロセスが閾値を超える事象が頻発したり、<br>phpのバグを踏んだりした際に。なにが原因なのか究明のために行ったときの備忘録。</p>
<a id="more"></a>

<p>必ずSegmentation Faultが起きるようにphpを拡張して、デバッグしていく。</p>
<h3 id="php-extentionsを作成"><a href="#php-extentionsを作成" class="headerlink" title="php extentionsを作成"></a>php extentionsを作成</h3><p>まずSegmentation Faultとなるようにphpを拡張する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># php取得</span></span><br><span class="line">curl -s -O http://jp2.php.net/distributions/php-5.6.31.tar.gz</span><br><span class="line">tar -zxvf php-5.6.31.tar.gz</span><br><span class="line"><span class="built_in">cd</span> php-5.6.31/ext</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拡張を作成するためのスケルトンを作成</span></span><br><span class="line">./ext_skel --extname=example</span><br><span class="line">Creating directory example</span><br><span class="line">Creating basic files: config.m4 config.w32 .gitignore example.c php_example.h CREDITS EXPERIMENTAL tests/001.phpt example.php [<span class="keyword">done</span>].</span><br><span class="line"></span><br><span class="line">To use your new extension, you will have to execute the following steps:</span><br><span class="line"></span><br><span class="line">1.  $ <span class="built_in">cd</span> ..</span><br><span class="line">2.  $ vi ext/example/config.m4</span><br><span class="line">3.  $ ./buildconf</span><br><span class="line">4.  $ ./configure --[with|<span class="built_in">enable</span>]-example</span><br><span class="line">5.  $ make</span><br><span class="line">6.  $ ./sapi/cli/php -f ext/example/example.php</span><br><span class="line">7.  $ vi ext/example/example.c</span><br><span class="line">8.  $ make</span><br><span class="line"></span><br><span class="line">Repeat steps 3-6 until you are satisfied with ext/example/config.m4 and</span><br><span class="line">step 6 confirms that your module is compiled into PHP. Then, start writing</span><br><span class="line">code and repeat the last two steps as often as necessary.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示された手順に従い拡張を作成していく</span></span><br><span class="line"><span class="built_in">cd</span> example</span><br><span class="line"></span><br><span class="line">vi config.m4</span><br></pre></td></tr></table></figure>

<p>生成されたconfig.m4を編集する。<br>以下の箇所をコメントインする</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* config.m4 */</span><br><span class="line"><span class="deletion">- dnl PHP_ARG_WITH(example, for example support,</span></span><br><span class="line"><span class="deletion">- dnl Make sure that the comment is aligned:</span></span><br><span class="line"><span class="deletion">- dnl [  --with-example             Include example support])</span></span><br><span class="line"><span class="addition">+ PHP_ARG_WITH(example, for example support,</span></span><br><span class="line"><span class="addition">+ Make sure that the comment is aligned:</span></span><br><span class="line"><span class="addition">+ [  --with-example             Include example support])</span></span><br></pre></td></tr></table></figure>

<p>拡張モジュールをビルドのためにphpizeする</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">phpize</span><br><span class="line"></span><br><span class="line">Configuring <span class="keyword">for</span>:</span><br><span class="line">PHP Api Version:         20121113</span><br><span class="line">Zend Module Api No:      20121212</span><br><span class="line">Zend Extension Api No:   220121212</span><br><span class="line"></span><br><span class="line">./configure</span><br><span class="line">...</span><br><span class="line">creating libtool</span><br><span class="line">appending configuration tag <span class="string">"CXX"</span> to libtool</span><br><span class="line">configure: creating ./config.status</span><br><span class="line">config.status: creating config.h</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Libraries have been installed <span class="keyword">in</span>:</span><br><span class="line">   /Users/kazu/Dropbox/workspace/debug-gdb/php-5.6.31/ext/example/modules</span><br><span class="line"></span><br><span class="line">If you ever happen to want to link against installed libraries</span><br><span class="line"><span class="keyword">in</span> a given directory, LIBDIR, you must either use libtool, and</span><br><span class="line">specify the full pathname of the library, or use the `-LLIBDIR<span class="string">'</span></span><br><span class="line"><span class="string">flag during linking and do at least one of the following:</span></span><br><span class="line"><span class="string">   - add LIBDIR to the `DYLD_LIBRARY_PATH'</span> environment variable</span><br><span class="line">     during execution</span><br><span class="line"></span><br><span class="line">See any operating system documentation about shared libraries <span class="keyword">for</span></span><br><span class="line">more information, such as the ld(1) and ld.so(8) manual pages.</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build complete.</span><br><span class="line">Don<span class="string">'t forget to run '</span>make <span class="built_in">test</span><span class="string">'.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">php -d extension=modules/example.so example.php</span></span><br><span class="line"><span class="string">Functions available in the test extension:</span></span><br><span class="line"><span class="string">confirm_example_compiled</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Congratulations! You have successfully modified ext/example/config.m4. Module example is now compiled into PHP.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vi example.c</span></span><br></pre></td></tr></table></figure>

<p>example.cに拡張を追加していく。<br>拡張を実装する。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">/* example.c */</span><br><span class="line"></span><br><span class="line"> const zend_function_entry example_functions[] = &#123;</span><br><span class="line">	 PHP_FE(confirm_example_compiled,	NULL)		/* For testing,  remove later. */</span><br><span class="line">     /* 新しいphpメソッドを追加する */</span><br><span class="line"><span class="addition">+	 PHP_FE(down_method, NULL)</span></span><br><span class="line">	 PHP_FE_END	/* Must be the last line in example_functions[] */</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(confirm_example_compiled)</span><br><span class="line">&#123;</span><br><span class="line">	char *arg = NULL;</span><br><span class="line">	int arg_len, len;</span><br><span class="line">	char *strg;</span><br><span class="line"></span><br><span class="line">	if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "s", &amp;arg, &amp;arg_len) == FAILURE) &#123;</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	len = spprintf(&amp;strg, 0, "Congratulations! You have successfully modified ext/%.78s/config.m4. Module %.78s is now compiled into PHP.", "example", arg);</span><br><span class="line">	RETURN_STRINGL(strg, len, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+ /* NULLアドレスの参照で必ず落ちる */</span></span><br><span class="line"><span class="addition">+ PHP_FUNCTION(down_method)</span></span><br><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+ 	char *ptr = NULL ;</span></span><br><span class="line"><span class="addition">+     strcpy(ptr, "down") ;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br><span class="line"></span><br><span class="line">zend_module_entry example_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	"example",</span><br><span class="line">	example_functions,</span><br><span class="line"><span class="deletion">-	PHP_MINIT(example),</span></span><br><span class="line"><span class="deletion">-	PHP_MSHUTDOWN(example),</span></span><br><span class="line"><span class="deletion">-	PHP_RINIT(example),		/* Replace with NULL if there's nothing to do at request start */</span></span><br><span class="line"><span class="deletion">-	PHP_RSHUTDOWN(example),	/* Replace with NULL if there's nothing to do at request end */</span></span><br><span class="line"><span class="deletion">-	PHP_MINFO(example),</span></span><br><span class="line"><span class="deletion">-	PHP_EXAMPLE_VERSION,</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line">zend_module_entry example_module_entry = &#123;</span><br><span class="line"> 	STANDARD_MODULE_HEADER,</span><br><span class="line"> 	"example",</span><br><span class="line"> 	example_functions,</span><br><span class="line"><span class="addition">+	NULL,</span></span><br><span class="line"><span class="addition">+	NULL,</span></span><br><span class="line"><span class="addition">+	NULL,		/* Replace with NULL if there's nothing to do at request start */</span></span><br><span class="line"><span class="addition">+	NULL,	/* Replace with NULL if there's nothing to do at request end */</span></span><br><span class="line"><span class="addition">+	NULL,</span></span><br><span class="line"><span class="addition">+	NO_VERSION_YET,</span></span><br><span class="line"> 	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>makeする</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>一応これで必ずSegmentation Faultふがおきるphpのメソッドができた。</p>
<h3 id="コンテナの起動"><a href="#コンテナの起動" class="headerlink" title="コンテナの起動"></a>コンテナの起動</h3><p>いろいろとコアな変更もしたいので <strong>privileged</strong> でコンテナを起動。</p>
<p>コアファイルへのアクセスやプロセスのtraceなどを行うため、コンテナ起動時にはcapabilityの追加の追加をしておく。</p>
<p>またcoreファイルのシステムリソールを変更する(unlimitedではエラーになるので十分に大きな数字を渡す)。</p>
<p>コンテナ内のシステムコールへのアクセスがセキュリティ的にだめなので、<strong>security-opt</strong> オプションを追加。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build and run container</span></span><br><span class="line">docker build -t kazu69/debug_apache_php_with_gdb .</span><br><span class="line"></span><br><span class="line"><span class="comment"># run container</span></span><br><span class="line">docker run -d \</span><br><span class="line">           -p 8080:80 \</span><br><span class="line">           --privileged \</span><br><span class="line">           --<span class="built_in">ulimit</span> core=9999999999 \</span><br><span class="line">           --<span class="built_in">cap</span>-add=SYS_PTRACE \</span><br><span class="line">           --security-opt seccomp:unconfined \</span><br><span class="line">           kazu69/debug_apache_php_with_gdb</span><br></pre></td></tr></table></figure>

<h3 id="straceでシステムコールを眺める"><a href="#straceでシステムコールを眺める" class="headerlink" title="straceでシステムコールを眺める"></a>straceでシステムコールを眺める</h3><p>デバッグの際によく使われるのがstrace。<br>プロセスがどの動きをしているのか(カーネルのシステムコール)をtraceする。</p>
<p>今回はphpで <strong>gethostbyaddr</strong> を実行してそれをtraceしてみる。<br>わかりやすいようにapacheのコプロセスを1つにしている。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -T 各システムコールにかかった時間</span></span><br><span class="line"><span class="comment"># t timestampを出力</span></span><br><span class="line"><span class="comment"># ff forkしたプロセスのシステムコールもトレース</span></span><br><span class="line"><span class="comment"># p プロセスID</span></span><br><span class="line"><span class="comment"># o 指定したファイルに出力</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># strace -T -t -ff -o &lt;path-to-log-file&gt; -p &lt;pid&gt;</span></span><br><span class="line"></span><br><span class="line">pstree -p</span><br><span class="line">apache2(1)---apache2(44)</span><br><span class="line"></span><br><span class="line">strace -p 44</span><br><span class="line">Process 44 attached</span><br><span class="line">accept4(3, &#123;sa_family=AF_INET, sin_port=htons(55964), sin_addr=inet_addr(<span class="string">"172.17.0.1"</span>)&#125;, [16], SOCK_CLOEXEC) = 11</span><br><span class="line">gettimeofday(&#123;1505745624, 9024&#125;, NULL)  = 0</span><br><span class="line">getsockname(11, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr(<span class="string">"172.17.0.2"</span>)&#125;, [16]) = 0</span><br><span class="line">fcntl(11, F_GETFL)                      = 0x2 (flags O_RDWR)</span><br><span class="line">fcntl(11, F_SETFL, O_RDWR|O_NONBLOCK)   = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9284&#125;, NULL)  = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f11695fc000</span><br><span class="line">gettimeofday(&#123;1505745624, 9440&#125;, NULL)  = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f11695fa000</span><br><span class="line"><span class="built_in">read</span>(11, <span class="string">"GET / HTTP/1.1\r\nHost: localhost:"</span>..., 8000) = 503</span><br><span class="line">gettimeofday(&#123;1505745624, 9617&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9679&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9739&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9771&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9803&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9836&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9870&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9920&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9947&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 9986&#125;, NULL)  = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 10038&#125;, NULL) = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 10198&#125;, NULL) = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 10257&#125;, NULL) = 0</span><br><span class="line"><span class="built_in">stat</span>(<span class="string">"/var/www/html/"</span>, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">open(<span class="string">"/var/www/.htaccess"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">"/var/www/html/.htaccess"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f11695f8000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f11695f6000</span><br><span class="line"><span class="built_in">stat</span>(<span class="string">"/var/www/html/index.php"</span>, &#123;st_mode=S_IFREG|0644, st_size=44, ...&#125;) = 0</span><br><span class="line">setitimer(ITIMER_PROF, &#123;it_interval=&#123;0, 0&#125;, it_value=&#123;30, 0&#125;&#125;, NULL) = 0</span><br><span class="line">rt_sigaction(SIGPROF, &#123;0x7f11652f0190, [PROF], SA_RESTORER|SA_RESTART, 0x7f11688f20e0&#125;, &#123;SIG_DFL, [], 0&#125;, 8) = 0</span><br><span class="line">rt_sigprocmask(SIG_UNBLOCK, [PROF], NULL, 8) = 0</span><br><span class="line">getcwd(<span class="string">"/var/www/html"</span>, 4095)           = 14</span><br><span class="line"><span class="built_in">chdir</span>(<span class="string">"/var/www/html"</span>)                  = 0</span><br><span class="line">lstat(<span class="string">"/var/www/html/index.php"</span>, &#123;st_mode=S_IFREG|0644, st_size=44, ...&#125;) = 0</span><br><span class="line">lstat(<span class="string">"/var/www/html"</span>, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">lstat(<span class="string">"/var/www"</span>, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">lstat(<span class="string">"/var"</span>, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">open(<span class="string">"/var/www/html/index.php"</span>, O_RDONLY) = 12</span><br><span class="line">fstat(12, &#123;st_mode=S_IFREG|0644, st_size=44, ...&#125;) = 0</span><br><span class="line">fstat(12, &#123;st_mode=S_IFREG|0644, st_size=44, ...&#125;) = 0</span><br><span class="line">fstat(12, &#123;st_mode=S_IFREG|0644, st_size=44, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 44, PROT_READ, MAP_SHARED, 12, 0) = 0x7f11695f5000</span><br><span class="line">munmap(0x7f11695f5000, 44)              = 0</span><br><span class="line">close(12)                               = 0</span><br><span class="line">open(<span class="string">"/etc/hosts"</span>, O_RDONLY|O_CLOEXEC)  = 12</span><br><span class="line">fstat(12, &#123;st_mode=S_IFREG|0644, st_size=174, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f11695f5000</span><br><span class="line"><span class="built_in">read</span>(12, <span class="string">"127.0.0.1\tlocalhost\n::1\tlocalhos"</span>..., 4096) = 174</span><br><span class="line"><span class="built_in">read</span>(12, <span class="string">""</span>, 4096)                      = 0</span><br><span class="line">close(12)                               = 0</span><br><span class="line">munmap(0x7f11695f5000, 4096)            = 0</span><br><span class="line">open(<span class="string">"/etc/ld.so.cache"</span>, O_RDONLY|O_CLOEXEC) = 12</span><br><span class="line">fstat(12, &#123;st_mode=S_IFREG|0644, st_size=15545, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 15545, PROT_READ, MAP_PRIVATE, 12, 0) = 0x7f11695f2000</span><br><span class="line">close(12)                               = 0</span><br><span class="line">access(<span class="string">"/etc/ld.so.nohwcap"</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">"/lib/x86_64-linux-gnu/libnss_dns.so.2"</span>, O_RDONLY|O_CLOEXEC) = 12</span><br><span class="line"><span class="built_in">read</span>(12, <span class="string">"\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\21\0\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(12, &#123;st_mode=S_IFREG|0644, st_size=22952, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2117896, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 12, 0) = 0x7f115f1fe000</span><br><span class="line">mprotect(0x7f115f203000, 2093056, PROT_NONE) = 0</span><br><span class="line">mmap(0x7f115f402000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 12, 0x4000) = 0x7f115f402000</span><br><span class="line">close(12)                               = 0</span><br><span class="line">mprotect(0x7f115f402000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7f11695f2000, 15545)           = 0</span><br><span class="line"><span class="built_in">stat</span>(<span class="string">"/etc/resolv.conf"</span>, &#123;st_mode=S_IFREG|0644, st_size=153, ...&#125;) = 0</span><br><span class="line">socket(PF_INET, SOCK_DGRAM|SOCK_NONBLOCK, IPPROTO_IP) = 12</span><br><span class="line">connect(12, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(<span class="string">"192.168.65.1"</span>)&#125;, 16) = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 15912&#125;, NULL) = 0</span><br><span class="line">poll([&#123;fd=12, events=POLLOUT&#125;], 1, 0)   = 1 ([&#123;fd=12, revents=POLLOUT&#125;])</span><br><span class="line">sendto(12, <span class="string">"\307\302\1\0\0\1\0\0\0\0\0\0\0018\0018\0018\0018\7in-addr\4arp"</span>..., 38, MSG_NOSIGNAL, NULL, 0) = 38</span><br><span class="line">poll([&#123;fd=12, events=POLLIN&#125;], 1, 5000) = 1 ([&#123;fd=12, revents=POLLIN&#125;])</span><br><span class="line">ioctl(12, FIONREAD, [82])               = 0</span><br><span class="line">recvfrom(12, <span class="string">"\307\302\201\200\0\1\0\1\0\0\0\0\0018\0018\0018\0018\7in-addr\4arp"</span>..., 1024, 0, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(<span class="string">"192.168.65.1"</span>)&#125;, [16]) = 82</span><br><span class="line">close(12)                               = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f11695f4000</span><br><span class="line"><span class="built_in">chdir</span>(<span class="string">"/var/www/html"</span>)                  = 0</span><br><span class="line">setitimer(ITIMER_PROF, &#123;it_interval=&#123;0, 0&#125;, it_value=&#123;0, 0&#125;&#125;, NULL) = 0</span><br><span class="line">setitimer(ITIMER_PROF, &#123;it_interval=&#123;0, 0&#125;, it_value=&#123;0, 0&#125;&#125;, NULL) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f11695f2000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f11695f0000</span><br><span class="line">gettimeofday(&#123;1505745624, 54797&#125;, NULL) = 0</span><br><span class="line"><span class="built_in">read</span>(11, 0x7f11695fa048, 8000)          = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">gettimeofday(&#123;1505745624, 56175&#125;, NULL) = 0</span><br><span class="line">writev(11, [&#123;<span class="string">"HTTP/1.1 200 OK\r\nDate: Mon, 18 S"</span>..., 230&#125;, &#123;<span class="string">"google-public-dns-a.google.com"</span>, 30&#125;], 2) = 260</span><br><span class="line">gettimeofday(&#123;1505745624, 57097&#125;, NULL) = 0</span><br><span class="line">write(8, <span class="string">"172.17.0.1 - - [18/Sep/2017:14:4"</span>..., 197) = 197</span><br><span class="line"><span class="built_in">times</span>(&#123;tms_utime=0, tms_stime=0, tms_cutime=0, tms_cstime=0&#125;) = 4298231454</span><br><span class="line">gettimeofday(&#123;1505745624, 58609&#125;, NULL) = 0</span><br><span class="line">gettimeofday(&#123;1505745624, 58935&#125;, NULL) = 0</span><br><span class="line">poll([&#123;fd=11, events=POLLIN&#125;], 1, 5000) = 0 (Timeout)</span><br><span class="line">gettimeofday(&#123;1505745629, 68368&#125;, NULL) = 0</span><br><span class="line">gettimeofday(&#123;1505745629, 68817&#125;, NULL) = 0</span><br><span class="line">gettimeofday(&#123;1505745629, 69508&#125;, NULL) = 0</span><br><span class="line">gettimeofday(&#123;1505745629, 70214&#125;, NULL) = 0</span><br><span class="line">shutdown(11, SHUT_WR)                   = 0</span><br><span class="line">poll([&#123;fd=11, events=POLLIN&#125;], 1, 2000) = 0 (Timeout)</span><br><span class="line">close(11)                               = 0</span><br><span class="line"><span class="built_in">read</span>(4, 0x7ffd1b7c265f, 1)              = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">gettimeofday(&#123;1505745631, 75664&#125;, NULL) = 0</span><br></pre></td></tr></table></figure>

<p>なんとなく TCPで53ポートで通信して、<br>HTTP/1.1でレスポンスが来ていることなどもわかる。<br>プロセスの動きをトレースすることでプログラムとカーネル側かの問題を切り分けることができる。</p>
<h3 id="gdbを使って原因を追う"><a href="#gdbを使って原因を追う" class="headerlink" title="gdbを使って原因を追う"></a>gdbを使って原因を追う</h3><p>最初に使った必ずエラーとなるphpを実行してSegmentation Faultを起こし、<br>coreファイルを出力してgdbでデバッグしてみる。</p>
<p>coreファイルはダンプした時点でのメモリ内容をそのまま記録しているので、そこから原因を特定できる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># php moduleが読込まれていること確認</span></span><br><span class="line">php -m | grep example</span><br><span class="line">example</span><br><span class="line"></span><br><span class="line"><span class="comment"># Segmentation faultになる</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/php /var/www/html/error.php</span><br><span class="line">Segmentation fault (core dumped)</span><br><span class="line"></span><br><span class="line"><span class="comment"># プロセス確認</span></span><br><span class="line"><span class="comment"># child processは1つにしておく</span></span><br><span class="line">pstree -p</span><br><span class="line">apache2(1)---apache2(16)</span><br><span class="line"></span><br><span class="line">ps -e -o ppid,pid,<span class="built_in">stat</span>,<span class="built_in">command</span> | grep apache2</span><br><span class="line">    0     1 Ss   apache2 -DFOREGROUND</span><br><span class="line">    1    16 S    apache2 -DFOREGROUND</span><br></pre></td></tr></table></figure>

<p>apacheなどのプロセスが長時間実行されている場合などは、<br>gcore(generate-core-file)でcoreダンプファイルを作成してみる。</p>
<p>gdbでプロセスにアタッチすることでデバッグはできるが、gdbがプロセス制御を奪うため、next, step, run, continueなどでプログラムを実行しないと停止している状態となるため稼働中のapcheのプロセスなどには使えない。</p>
<p>gcoreを使った場合はcoreダンプファイルを作成している間だけattachされるため、プログラムの停止を最小に止めることができる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">gcore 16</span><br><span class="line"></span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line">0x00007f8754335190 <span class="keyword">in</span> __write_nocancel () at ../sysdeps/unix/syscall-template.S:84</span><br><span class="line">84	../sysdeps/unix/syscall-template.S: No such file or directory.</span><br><span class="line">warning: target file /proc/15/cmdline contained unexpected null characters</span><br><span class="line">Saved corefile core.16</span><br><span class="line"></span><br><span class="line"><span class="comment"># core ファイルができている</span></span><br><span class="line">ls</span><br><span class="line">core.16</span><br><span class="line"></span><br><span class="line"><span class="comment"># coreファイルにアタッチする</span></span><br><span class="line">gdb /usr/sbin/apache2 -c core.16</span><br><span class="line">GNU gdb (Debian 7.12-6) 7.12.0.20161007-git</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from /usr/sbin/apache2...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">[New LWP 16]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line">Core was generated by `apache2<span class="string">'.</span></span><br><span class="line"><span class="string">#0  0x00007f9a03637690 in __poll_nocancel () at ../sysdeps/unix/syscall-template.S:84</span></span><br><span class="line"><span class="string">84	../sysdeps/unix/syscall-template.S: No such file or directory.</span></span><br></pre></td></tr></table></figure>

<p>またSegmentation Faultが起きる場合はプロセスいなくなるので、あらかじめcoreファイルを出力するように設定しておくこともある。<br>この場合、エラーが発生すると所定のcoreファイルが出力される。</p>
<p>今回はphpで実際にSegmentation Faultを起こしてcoreファイルを吐き出す。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8080/error.php</span><br><span class="line"></span><br><span class="line">ls /tmp</span><br><span class="line">core.cc0a7a572fde.apache2.1505406197</span><br></pre></td></tr></table></figure>

<p>gdbでcoreファイルをデバッグ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">gdb /usr/sbin/apache2 -c core.cc0a7a572fde.apache2.1505406197</span><br><span class="line"></span><br><span class="line">GNU gdb (Debian 7.7.1+dfsg-5) 7.7.1</span><br><span class="line">Copyright (C) 2014 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from /usr/sbin/apache2...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">[New LWP 31]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line">Core was generated by `apache2 -DFOREGROUND<span class="string">'.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="string">#0  zif_down_method (ht=0, return_value=0x7f70ac52b210, return_value_ptr=0x7f70ac4f9088, this_ptr=0x0, return_value_used=0) at /tmp/extensions/example/example.c:72</span></span><br><span class="line"><span class="string">72	    strcpy(ptr, "down") ;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># バックトレース</span></span><br><span class="line"><span class="string">(gdb) bt</span></span><br><span class="line"><span class="string">#0  zif_down_method (ht=0, return_value=0x7f70ac52b210, return_value_ptr=0x7f70ac4f9088, this_ptr=0x0, return_value_used=0) at /tmp/extensions/example/example.c:72</span></span><br><span class="line"><span class="string">#1  0x00007f70a8241173 in zend_do_fcall_common_helper_SPEC () from /usr/lib/apache2/modules/libphp5.so</span></span><br><span class="line"><span class="string">#2  0x00007f70a81ca360 in execute_ex () from /usr/lib/apache2/modules/libphp5.so</span></span><br><span class="line"><span class="string">#3  0x00007f70a81929d0 in zend_execute_scripts () from /usr/lib/apache2/modules/libphp5.so</span></span><br><span class="line"><span class="string">#4  0x00007f70a812dfc0 in php_execute_script () from /usr/lib/apache2/modules/libphp5.so</span></span><br><span class="line"><span class="string">#5  0x00007f70a82428ca in php_handler () from /usr/lib/apache2/modules/libphp5.so</span></span><br><span class="line"><span class="string">#6  0x000055798cdc3880 in ap_run_handler ()</span></span><br><span class="line"><span class="string">#7  0x000055798cdc3dc9 in ap_invoke_handler ()</span></span><br><span class="line"><span class="string">#8  0x000055798cdd9ca2 in ap_process_async_request ()</span></span><br><span class="line"><span class="string">#9  0x000055798cdd9e40 in ap_process_request ()</span></span><br><span class="line"><span class="string">#10 0x000055798cdd6742 in ?? ()</span></span><br><span class="line"><span class="string">#11 0x000055798cdcd130 in ap_run_process_connection ()</span></span><br><span class="line"><span class="string">#12 0x00007f70a8c757ba in ?? () from /usr/lib/apache2/modules/mod_mpm_prefork.so</span></span><br><span class="line"><span class="string">#13 0x00007f70a8c75a01 in ?? () from /usr/lib/apache2/modules/mod_mpm_prefork.so</span></span><br><span class="line"><span class="string">#14 0x00007f70a8c76667 in ?? () from /usr/lib/apache2/modules/mod_mpm_prefork.so</span></span><br><span class="line"><span class="string">#15 0x000055798cda784e in ap_run_mpm ()</span></span><br><span class="line"><span class="string">#16 0x000055798cda0673 in main ()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># エラーが発生したファイル</span></span><br><span class="line"><span class="string">print (char *)executor_globals.active_op_array-&gt;filename</span></span><br><span class="line"><span class="string">$1 = 0x7f70ac529bc8 "/var/www/html/error.php"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># エラーの発生した行数</span></span><br><span class="line"><span class="string">print executor_globals.current_execute_data.opline-&gt;lineno</span></span><br><span class="line"><span class="string">$2=2</span></span><br></pre></td></tr></table></figure>

<p>上記の内容から想定通りexample.c 72行目で落ちていることがわかる。</p>
<h3 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h3><p>普段アプリケーションレイヤーを開発している人からすると、だいたいこの辺かなという感じで問題点を追うことができるが、はっきりとして原因を掴むために、<br>straceやgdbなどで追求できるようにしておくことは良いことだと思われた。</p>
<p>低レイヤーでの開発している人にとっては目新しいことではないでしょうが…</p>
<h3 id="今回使ったサンプル"><a href="#今回使ったサンプル" class="headerlink" title="今回使ったサンプル"></a>今回使ったサンプル</h3><p><a href="https://github.com/kazu69/example-debug-apache-service-operating" target="_blank" rel="noopener">example-debug-apache-service-operating</a></p>
<h3 id="参考にしたページ"><a href="#参考にしたページ" class="headerlink" title="参考にしたページ"></a>参考にしたページ</h3><p><a href="https://techblog.yahoo.co.jp/tips/php/" target="_blank" rel="noopener">PHPでのデバッグ方法</a><br><a href="https://net-newbie.com/phpext/" target="_blank" rel="noopener">PHP Extension 開発入門</a><br><a href="https://httpd.apache.org/dev/debugging.html#gdb" target="_blank" rel="noopener">Apache HTTPD Debugging Guide - The Apache HTTP Server Project</a></p>

    
  </div>

  
    <footer class="article-footer">

      
        <aside class="google-adsence">
          
<!-- Google Adsence -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4054575508733221" data-ad-slot="9493597992" data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- End Google Adsence -->


        </aside>
      

      <div class="share_content">
  <div class="hatena_sharebox">
    
      <a href="http://b.hatena.ne.jp/entry/blog.kazu69.net/2017/09/11/running-apache-process-php-error-gdb/" class="hatena-bookmark-button" data-hatena-bookmark-title="稼働中のapacheプロセスやphpエラーgdbで追う" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  </div>
  
    <div class="addthis addthis_toolbox addthis_default_style">
      
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
      
      
        <a class="addthis_button_tweet"></a>
      
      
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
      
      
      <!-- <a class="addthis_counter addthis_pill_style"></a> -->
    </div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55a4f49a45ced975"></script>
  
</div>

      
        <a href="http://blog.kazu69.net/2017/09/11/running-apache-process-php-error-gdb/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  

  
    
<nav id="article-nav">
  <div class="article-nav">
    
      <a href="/2017/10/20/filter_environment_variables_brew/" id="article-nav-newer" class="article-nav-link article-nav-link-newer">
        <span class="article-nav-caption">Newer - </span>
        <span class="article-nav-title">
          
            brewのHOMEBREW_ENV_FILTERINGフラグを知った
          
        </span>
      </a>
    
    
      <a href="/2017/08/20/memory-management-go/" id="article-nav-older" class="article-nav-link article-nav-link-older">
        <span class="article-nav-caption">Older - </span>
        <span class="article-nav-title">
          
            Goのメモリ管理を眺めてみた
          
        </span>
        
      </a>
    
  </div>
</nav>

  
</article>


<section class="comments" id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      
    </main>
    <footer id="footer" role="contentinfo">
  
  <div class="footer-cotent">
    <small>&copy; 2019 kazu69</small>
    <span class="generator">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
  </div>
</footer>
    
<script>
  var disqus_shortname = '69log';
  
  var disqus_url = 'http://blog.kazu69.net/2017/09/11/running-apache-process-php-error-gdb/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</body>
</html>