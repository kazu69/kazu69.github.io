<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>PHPアプリケーションでのReact.jsのサーバーレンダリング考える | 69log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="PHPでReact.jsなアプリケーションを導入する時に眺めてみた時のメモ。">
<meta property="og:type" content="article">
<meta property="og:title" content="PHPアプリケーションでのReact.jsのサーバーレンダリング考える">
<meta property="og:url" content="http://blog.kazu69.net/2016/04/17/rendering_reactjs_template_server_side_in_php_application/index.html">
<meta property="og:site_name" content="69log">
<meta property="og:description" content="PHPでReact.jsなアプリケーションを導入する時に眺めてみた時のメモ。">
<meta property="og:updated_time" content="2016-04-26T04:59:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PHPアプリケーションでのReact.jsのサーバーレンダリング考える">
<meta name="twitter:description" content="PHPでReact.jsなアプリケーションを導入する時に眺めてみた時のメモ。">
  
    <link rel="alternative" href="/atom.xml" title="69log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-9196861-14', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
    <header role="header">
  <div class="header cf">
    <div class="title-content">
      <h1>
        <a href="/">69log</a>
      </h1>
      
        <h2>
          <a href="/">福岡でwebの仕事をしています</a>
        </h2>
      
    </div>

    <div class="nav-content cf">
      <nav>
        
          <a href="/" class="nav-link nav-home">home</a>
        
          <a href="/archives" class="nav-link nav-archives">archives</a>
        
        
          <a href="/atom.xml" title="RSS Feed" class="icon nav-link nav-feed"></a>
        
      </nav>
      <div class="header-search">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://blog.kazu69.net"></form>
      </div>
    </div>
  </div>
</header>

    <main role="main" id="main">
      <section><article id="post-rendering_reactjs_template_server_side_in_php_application" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    
      
  
    <h1 class="article-title" itemprop="name">
      PHPアプリケーションでのReact.jsのサーバーレンダリング考える
    </h1>
  

    
    <div class="article-meta clr">
      <time datetime="2016-04-17T09:08:21.000Z" itemprop="datePublished">2016-04-17</time>

      
  <div class="article-category">
    <a class="article-category-link" href="/categories/tec/">tec</a>
  </div>


    </div>
  </header>

  <div class="article-entry" itemprop="articleBody">
    <div class="article-gallery">
      
    </div>
    
      <p>PHPでReact.jsなアプリケーションを導入する時に眺めてみた時のメモ。</p>
<a id="more"></a>
<p>まず、ブラウザからのリクエストに対して、サーバー側でDOMをレンダリングする必要がある。<br>これは、ブラウザでDOMレンダリングする場合は、サーチエンジンのアクセスに対して、<br>空の要素を返してしまう。<br>そのため、その結果がインデックスされるとSEO的によろしくないからである。</p>
<p>そこで、どこでReact.jsを実行してDOMを生成するのかを考える必要がある。</p>
<ul>
<li>PHPでJSを実行する</li>
<li>React.jsをレンダリングする小さなアプリケーションに処理を委譲する</li>
</ul>
<p>の2つのパターンを考えられる。</p>
<p>例として簡単なView Classのテンプレートをレンダリングする。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">    <span class="keyword">this</span>.countUp = <span class="keyword">this</span>.countUp.bind(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">this</span>.countDown = <span class="keyword">this</span>.countDown.bind(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">this</span>.state = &#123;</div><div class="line">      <span class="attr">count</span>: <span class="keyword">this</span>.props.count</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">   <span class="keyword">static</span> defaultProps = &#123;</div><div class="line">    <span class="attr">count</span>: <span class="number">0</span></div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">static</span> propTypes = &#123;</div><div class="line">    <span class="attr">count</span>: React.PropTypes.number.isRequired</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  countUp(event) &#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">count</span>: <span class="keyword">this</span>.state.count + <span class="number">1</span>&#125;);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  countDown(event) &#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">count</span>: <span class="keyword">this</span>.state.count - <span class="number">1</span>&#125;);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span>(</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">'counter'</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">'count'</span>&gt;</span></div><div class="line">          &#123;this.state.count&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.countUp.bind(this)&#125;</span>&gt;</span> count up <span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.countDown.bind(this)&#125;</span>&gt;</span> count down <span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="PHPでJSを実行する"><a href="#PHPでJSを実行する" class="headerlink" title="PHPでJSを実行する"></a>PHPでJSを実行する</h3><p>PHPに<a href="http://php.net/manual/ja/book.v8js.php" target="_blank" rel="external">V8jsモジュール</a>を追加することで、<br>jsをコンパイルして実行できるようになる。<br>(require: PHP &gt;= 5.3.3)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># install v8js</span></div><div class="line">pecl install v8js-0.1.3 \</div><div class="line"><span class="built_in">echo</span> <span class="string">"extension=v8js.so"</span> &gt;&gt; /etc/php5/cli/php.ini</div><div class="line"></div><div class="line"><span class="comment"># install composer</span></div><div class="line">curl <span class="_">-s</span>S https://getcomposer.org/installer | php -- --install-dir=/usr/<span class="built_in">local</span>/bin --filename=composer</div><div class="line"></div><div class="line"><span class="comment"># オプションを追加してconfigure</span></div><div class="line">./configure --with-freetype-dir=/usr/include/ \</div><div class="line">            --with-jpeg-dir=/usr/include/ \</div><div class="line">            --with-gd \</div><div class="line">            --with-mcrypt \</div><div class="line">            --with-libzip \</div><div class="line">            --with-bz2 \</div><div class="line">            --enable-mbstring \</div><div class="line">            --enable-v8js</div></pre></td></tr></table></figure>
<p>通常ブラウザ向けにReact.jsを提供するのと同じように、<br><a href="http://browserify.org/" target="_blank" rel="external">Browserify</a>を使いbundleし、v8jsでphpを実行する。</p>
<p>最終的に<strong>renderToString</strong>でreactIdを割り振られたDOMを出力する。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require_once</span> dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/../vendor/autoload.php'</span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_markup</span><span class="params">($component, $prop)</span> </span>&#123;</div><div class="line">  $default_prop = json_encode($prop);</div><div class="line">  $v8 = <span class="keyword">new</span> V8Js();</div><div class="line">  $js[] = <span class="string">"var global = global || this, self = self || this, window = window || this;"</span>;</div><div class="line">  $js[] = file_get_contents(<span class="string">'js/bundle.min.js'</span>, <span class="keyword">true</span>);</div><div class="line">  $js[] = <span class="string">"print(ReactDomServer.renderToString(React.createElement($&#123;component&#125;, $&#123;default_prop&#125;)));"</span>;</div><div class="line">  $code = implode(<span class="string">";\n"</span>, $js);</div><div class="line">  ob_start();</div><div class="line">  $v8-&gt;executeString($code);</div><div class="line">  <span class="keyword">return</span> ob_get_clean();</div><div class="line">&#125;</div><div class="line">$component = <span class="string">'Counter'</span>;</div><div class="line">$prop = [<span class="string">'count'</span> =&gt; <span class="number">3</span>];</div><div class="line">$markup = get_markup($component, $prop);</div></pre></td></tr></table></figure>
<p>Facebookの<a href="https://github.com/reactjs/react-php-v8js" target="_blank" rel="external">react-php-v8js</a>をそのままに処理を書いた。</p>
<p>PHPにモジュールを追加できるのであれば、PHP側でtemplateを返すほうが容易である。<br>とくにreact-php-v8jsなどを使うことで簡単に実装はできそう。</p>
<h3 id="テンプレート処理をレンダリングアプリケーションに委譲する"><a href="#テンプレート処理をレンダリングアプリケーションに委譲する" class="headerlink" title="テンプレート処理をレンダリングアプリケーションに委譲する"></a>テンプレート処理をレンダリングアプリケーションに委譲する</h3><p>稼動中でPHPアプリケーションに対して手を入れることができない場合などは、<br>このパターンを採用することが考えられる。<br>実際にReact.jsを実行するのはnodejsで書かれたサーバーになる。</p>
<p>PHPアプリケーションからはHTTPリクエストを送信するだけとなる。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$context = stream_context_create(</div><div class="line">    <span class="keyword">array</span>(</div><div class="line">        <span class="string">'http'</span> =&gt; <span class="keyword">array</span>(</div><div class="line">            <span class="string">'method'</span>=&gt; <span class="string">'POST'</span>,</div><div class="line">            <span class="string">'header'</span>=&gt; <span class="string">'Content-type: application/json; charset=UTF-8'</span>,</div><div class="line">            <span class="string">'content'</span> =&gt; json_encode(</div><div class="line">                <span class="keyword">array</span>(</div><div class="line">                    <span class="string">'count'</span> =&gt; <span class="number">4</span></div><div class="line">                )</div><div class="line">            )</div><div class="line">        )</div><div class="line">    )</div><div class="line">);</div><div class="line">$output = file_get_contents($url, <span class="keyword">false</span>, $context);</div></pre></td></tr></table></figure>
<p>という感じでPHPからPOSTされたdataに対して、<br>たとえば<a href="http://expressjs.com/" target="_blank" rel="external">express</a>でざっくりサーバーを書く。</p>
<p>こちらも最終的に<strong>renderToString</strong>でreactIdを割り振られたDOMを出力する。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</div><div class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">'express'</span>;</div><div class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</div><div class="line"><span class="keyword">import</span> ReactDOMServer <span class="keyword">from</span> <span class="string">'react-dom/server'</span>;</div><div class="line"><span class="keyword">import</span> bodyParser <span class="keyword">from</span> <span class="string">'body-parser'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> app = express();</div><div class="line">app.use(bodyParser.json());</div><div class="line"></div><div class="line">app.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">const</span> view = path.resolve(<span class="string">'./views/'</span> + req.query.component);</div><div class="line">    <span class="keyword">const</span> Component = <span class="built_in">require</span>(view).default;</div><div class="line">    <span class="keyword">const</span> props = req.body || <span class="literal">null</span>;</div><div class="line">    res.status(<span class="number">200</span>).send(</div><div class="line">      ReactDOMServer.renderToString(</div><div class="line">        React.createElement(Component, props)</div><div class="line">      )</div><div class="line">    );</div><div class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</div><div class="line">     res.status(<span class="number">500</span>).send(error.message);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'App listening on port 3000!'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>こうすることでテンプレートを処理をして、htmlを返すことだけに注力できる。<br>nodejsサーバーからのレスポンスをPHPのレスポンスとして出力してあげると良い。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl http://APPLICATION_IP/template_nodejs.php</div><div class="line"></div><div class="line">&lt;div id=<span class="string">"app"</span>&gt;&lt;div class=<span class="string">"counter"</span> data-reactroot=<span class="string">""</span> data-reactid=<span class="string">"1"</span> data-react-checksum=<span class="string">"685065078"</span>&gt;&lt;span class=<span class="string">"count"</span> data-reactid=<span class="string">"2"</span>&gt;4&lt;/span&gt;&lt;button data-reactid=<span class="string">"3"</span>&gt; count up &lt;/button&gt;&lt;button data-reactid=<span class="string">"4"</span>&gt; count down &lt;/button&gt;&lt;/div&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>仮にnodejsサーバーとPHPアプリケーションでのConnectionエラーなどがあった場合でも、<br>ブラウザレンダリング機構を用いれば、コンテンツが表示されないという致命的な問題は回避できる。</p>
<p>nodejsサーバーを採用した場合は、サーバーは常にステートレス(状態を保持しない)なので、<br>スケールアウトしやすく、またアプリケーションのテストも容易になる。</p>
<h3 id="そのほか"><a href="#そのほか" class="headerlink" title="そのほか"></a>そのほか</h3><p>どちらの方法採用しても、サーバーでレンダリングされたDOMに対して、<br>ブラウザ側でイベントをbindする必要がある。<br>この場合、すでにDOMがレンダリングされているので、React.jsはDOMを再描画する必要はない。</p>
<p>サーバーレンダリングを行うことで、ブラウザ側での描画を避けることができため、<br>サーバーからドキュメントがダウンロードされるとコンテンツが表示される。<br>つまり描画までの時間を短縮できる。</p>
<hr>
<p><a href="https://github.com/kazu69/render-reactjs-with-php-example/" target="_blank" rel="external">今回試したサンプル</a></p>
<h3 id="参考にしたページ"><a href="#参考にしたページ" class="headerlink" title="参考にしたページ"></a>参考にしたページ</h3><p><a href="http://php.net/manual/ja/book.v8js.php" target="_blank" rel="external">v8js</a><br><a href="https://github.com/reactjs/react-php-v8js" target="_blank" rel="external">react-php-v8js</a></p>

    
  </div>

  
    <footer class="article-footer">

      
        <aside class="google-adsence">
          
<!-- Google Adsence -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-4054575508733221"
   data-ad-slot="9493597992"
   data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- End Google Adsence -->


        </aside>
      

      <div class="share_content">
  <div class="hatena_sharebox">
    
      <a href="http://b.hatena.ne.jp/entry/blog.kazu69.net/2016/04/17/rendering_reactjs_template_server_side_in_php_application/" class="hatena-bookmark-button" data-hatena-bookmark-title="PHPアプリケーションでのReact.jsのサーバーレンダリング考える" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  </div>
  
    <div class="addthis addthis_toolbox addthis_default_style">
      
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
      
      
        <a class="addthis_button_tweet"></a>
      
      
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
      
      
      <!-- <a class="addthis_counter addthis_pill_style"></a> -->
    </div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55a4f49a45ced975"></script>
  
</div>

      
        <a href="http://blog.kazu69.net/2016/04/17/rendering_reactjs_template_server_side_in_php_application/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  

  
    
<nav id="article-nav">
  <div class="article-nav">
    
      <a href="/2016/05/02/npm-install-speedup-in-docker/" id="article-nav-newer" class="article-nav-link article-nav-link-newer">
        <span class="article-nav-caption">Newer - </span>
        <span class="article-nav-title">
          
            Dockerコンテナ内でのnpm installを改善してみる
          
        </span>
      </a>
    
    
      <a href="/2016/03/19/optimize_resources_using_resoucehint_and_preload/" id="article-nav-older" class="article-nav-link article-nav-link-older">
        <span class="article-nav-caption">Older - </span>
        <span class="article-nav-title">
          
            resouce hintsとpreloadを使ってリソースの取得を最適化する
          
        </span>
        </span>
      </a>
    
  </div>
</nav>

  
</article>


<section class="comments" id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      
    </main>
    <footer id="footer" role="contentinfo">
  
  <div class="footer-cotent">
    <small>&copy; 2017 kazu69</small>
    <span class="generator">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
  </div>
</footer>
    
<script>
  var disqus_shortname = '69log';
  
  var disqus_url = 'http://blog.kazu69.net/2016/04/17/rendering_reactjs_template_server_side_in_php_application/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</body>
</html>