<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>docker swarm mode を試してみる | 69log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="docker engine 1.12から標準で搭載されたswarm modeを試してみる。swarm(群れ)という意味で、クラスタリング構成機構のこと。swarm modeはdocker engine v1.12.0-rc1で統合された機能である。">
<meta property="og:type" content="article">
<meta property="og:title" content="docker swarm mode を試してみる">
<meta property="og:url" content="http://blog.kazu69.net/2016/08/09/try-docker-swarm-mode/index.html">
<meta property="og:site_name" content="69log">
<meta property="og:description" content="docker engine 1.12から標準で搭載されたswarm modeを試してみる。swarm(群れ)という意味で、クラスタリング構成機構のこと。swarm modeはdocker engine v1.12.0-rc1で統合された機能である。">
<meta property="og:locale" content="ja">
<meta property="og:updated_time" content="2016-08-18T04:45:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="docker swarm mode を試してみる">
<meta name="twitter:description" content="docker engine 1.12から標準で搭載されたswarm modeを試してみる。swarm(群れ)という意味で、クラスタリング構成機構のこと。swarm modeはdocker engine v1.12.0-rc1で統合された機能である。">
  
    <link rel="alternative" href="/atom.xml" title="69log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-9196861-14', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
    <header role="header">
  <div class="header cf">
    <div class="title-content">
      <h1>
        <a href="/">69log</a>
      </h1>
      
        <h2>
          <a href="/">福岡でwebの仕事をしています</a>
        </h2>
      
    </div>

    <div class="nav-content cf">
      <nav>
        
          <a href="/" class="nav-link nav-home">home</a>
        
          <a href="/archives" class="nav-link nav-archives">archives</a>
        
        
          <a href="/atom.xml" title="RSS Feed" class="icon nav-link nav-feed"></a>
        
      </nav>
      <div class="header-search">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://blog.kazu69.net"></form>
      </div>
    </div>
  </div>
</header>

    <main role="main" id="main">
      <section><article id="post-try-docker-swarm-mode" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    
      
  
    <h1 class="article-title" itemprop="name">
      docker swarm mode を試してみる
    </h1>
  

    
    <div class="article-meta clr">
      <time datetime="2016-08-09T09:17:13.000Z" itemprop="datePublished">2016-08-09</time>

      
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>


    </div>
  </header>

  <div class="article-entry" itemprop="articleBody">
    <div class="article-gallery">
      
    </div>
    
      <p>docker engine 1.12から標準で搭載されたswarm modeを試してみる。<br>swarm(群れ)という意味で、クラスタリング構成機構のこと。<br>swarm modeはdocker engine v1.12.0-rc1で統合された機能である。</p>
<a id="more"></a>
<p>swarm modeではクラスタをアプリケーション単位での管理し、<br>複数ホスト間で共有されるネットワークを持っているので、<br>外部のネットワークからのトラフィックをロード・バランシングできるという。</p>
<p>ということで、<a href="tps://pocketstudio.net/2016/06/23/docker-1-12-swarm-mode-and-ingress-load-balancing/" target="_blank" rel="noopener">チュートリアル</a>に沿って一通り眺める。</p>
<h2 id="nodeの作成"><a href="#nodeの作成" class="headerlink" title="nodeの作成"></a>nodeの作成</h2><table>
<thead>
<tr>
<th>node</th>
<th>role</th>
</tr>
</thead>
<tbody>
<tr>
<td>manager</td>
<td>master</td>
</tr>
<tr>
<td>worker1</td>
<td>worker</td>
</tr>
<tr>
<td>worker2</td>
<td>worker</td>
</tr>
</tbody>
</table>
<p>各ホストでdocker engine(dockerデーモン)を起動させる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create -d virtualbox manager</span><br><span class="line">docker-machine create -d virtualbox worker1</span><br><span class="line">docker-machine create -d virtualbox worker2</span><br><span class="line"></span><br><span class="line">NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER    ERRORS</span><br><span class="line">manager   *        virtualbox   Running   tcp://192.168.99.100:2376           v1.12.0</span><br><span class="line">worker1   -        virtualbox   Running   tcp://192.168.99.101:2376           v1.12.0</span><br><span class="line">worker2   -        virtualbox   Running   tcp://192.168.99.102:2376           v1.12.0</span><br><span class="line">docker-machine ip manager</span><br><span class="line">192.168.99.100</span><br></pre></td></tr></table></figure>
<h2 id="クラスタを初期化"><a href="#クラスタを初期化" class="headerlink" title="クラスタを初期化"></a>クラスタを初期化</h2><p>swarm initで、クラスタを初期化すると、tokenが発行される。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker swarm init --advertise-addr 192.168.99.100</span><br><span class="line">Swarm initialized: current node (5golpgkwh376tmddgzqcqzjpl) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following <span class="built_in">command</span>:</span><br><span class="line">    docker swarm join \</span><br><span class="line">    --token SWMTKN-1-0vbcihcfezog02z78j4cpmbptt5d917mcm71w0dbbxol0k8pgb-emc5tzyg4ri30i2uqrqlyi6yq \</span><br><span class="line">    192.168.99.100:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run the following <span class="built_in">command</span>:</span><br><span class="line">    docker swarm join \</span><br><span class="line">    --token SWMTKN-1-0vbcihcfezog02z78j4cpmbptt5d917mcm71w0dbbxol0k8pgb-dm8ugwds89z972yhngfgmv74l \</span><br><span class="line">    192.168.99.100:2377</span><br></pre></td></tr></table></figure>
<p>docker infoでswarmの現在の状況を確認してみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker info</span><br><span class="line">Containers: 0</span><br><span class="line"> Running: 0</span><br><span class="line"> Paused: 0</span><br><span class="line"> Stopped: 0</span><br><span class="line">Images: 0</span><br><span class="line">Server Version: 1.12.0</span><br><span class="line">Storage Driver: aufs</span><br><span class="line"> Root Dir: /mnt/sda1/var/lib/docker/aufs</span><br><span class="line"> Backing Filesystem: extfs</span><br><span class="line"> Dirs: 0</span><br><span class="line"> Dirperm1 Supported: <span class="literal">true</span></span><br><span class="line">Logging Driver: json-file</span><br><span class="line">Cgroup Driver: cgroupfs</span><br><span class="line">Plugins:</span><br><span class="line"> Volume: <span class="built_in">local</span></span><br><span class="line"> Network: host bridge overlay null</span><br><span class="line">Swarm: active</span><br><span class="line"> NodeID: 5golpgkwh376tmddgzqcqzjpl</span><br><span class="line"> Is Manager: <span class="literal">true</span></span><br><span class="line"> ClusterID: 7lpo0u0u57yryce83q22ne3ot</span><br><span class="line"> Managers: 1</span><br><span class="line"> Nodes:</span><br><span class="line"> ...</span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line">docker node ls</span><br><span class="line">ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS</span><br><span class="line">5golpgkwh376tmddgzqcqzjpl *  manager   Ready   Active        Leader</span><br></pre></td></tr></table></figure>
<h2 id="クラスタに追加"><a href="#クラスタに追加" class="headerlink" title="クラスタに追加"></a>クラスタに追加</h2><p>workder1, worker2をswarmクラスタにworkerとして追加する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker1</span></span><br><span class="line"></span><br><span class="line">docker swarm join --token SWMTKN-1-0vbcihcfezog02z78j4cpmbptt5d917mcm71w0dbbxol0k8pgb-emc5tzyg4ri30i2uqrqlyi6yq 192.168.99.100:2377</span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker2</span></span><br><span class="line"></span><br><span class="line">docker swarm join --token SWMTKN-1-0vbcihcfezog02z78j4cpmbptt5d917mcm71w0dbbxol0k8pgb-emc5tzyg4ri30i2uqrqlyi6yq 192.168.99.100:2377</span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>
<p>追加したnodeがswarmクラスタに追加されいることを確認する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker node ls</span><br><span class="line">ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS</span><br><span class="line">0mfxd3hhndyd7i4uncbiprek4    worker2   Ready   Active</span><br><span class="line">5golpgkwh376tmddgzqcqzjpl *  manager   Ready   Active        Leader</span><br><span class="line">cwdb1t7e3o9rstaiudaxswzu9    worker1   Ready   Active</span><br></pre></td></tr></table></figure>
<h2 id="ingressネットワークの作成"><a href="#ingressネットワークの作成" class="headerlink" title="ingressネットワークの作成"></a>ingressネットワークの作成</h2><p>ingressネットワーク(ingress)を作成し、ロードバランスする。<br>複数ホスト間のコンテナで外部からのリクエストをルーティングし、ロードバランシングできるようになる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker network create -d overlay testnetwork</span><br><span class="line">0s19bsmqf8wcblaur5ryb8biq</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">a2fab6cccfde        bridge              bridge              <span class="built_in">local</span></span><br><span class="line">3b4e201a5b10        docker_gwbridge     bridge              <span class="built_in">local</span></span><br><span class="line">cc20b3e97d14        host                host                <span class="built_in">local</span></span><br><span class="line">6uoqnkw5ei76        ingress             overlay             swarm</span><br><span class="line">83f4a43f1315        none                null                <span class="built_in">local</span></span><br><span class="line">0s19bsmqf8wc        testnetwork         overlay             swarm</span><br><span class="line"></span><br><span class="line">docker network inspect testnetwork</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"testnetwork"</span>,</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"0s19bsmqf8wcblaur5ryb8biq"</span>,</span><br><span class="line">        <span class="string">"Scope"</span>: <span class="string">"swarm"</span>,</span><br><span class="line">        <span class="string">"Driver"</span>: <span class="string">"overlay"</span>,</span><br><span class="line">        <span class="string">"EnableIPv6"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"IPAM"</span>: &#123;</span><br><span class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="string">"Options"</span>: null,</span><br><span class="line">            <span class="string">"Config"</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Internal"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Containers"</span>: null,</span><br><span class="line">        <span class="string">"Options"</span>: &#123;</span><br><span class="line">            <span class="string">"com.docker.network.driver.overlay.vxlanid_list"</span>: <span class="string">"257"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Labels"</span>: null</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>もうちょっとingressネットワークを見てみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker network inspect 6uoqnkw5ei76</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"ingress"</span>,</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"6uoqnkw5ei76chns289v0oaei"</span>,</span><br><span class="line">        <span class="string">"Scope"</span>: <span class="string">"swarm"</span>,</span><br><span class="line">        <span class="string">"Driver"</span>: <span class="string">"overlay"</span>,</span><br><span class="line">        <span class="string">"EnableIPv6"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"IPAM"</span>: &#123;</span><br><span class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="string">"Options"</span>: null,</span><br><span class="line">            <span class="string">"Config"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"Subnet"</span>: <span class="string">"10.255.0.0/16"</span>,</span><br><span class="line">                    <span class="string">"Gateway"</span>: <span class="string">"10.255.0.1"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Internal"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Containers"</span>: &#123;</span><br><span class="line">            <span class="string">"745c0806c4f7082995dd1cb8d04dca6becc6dbe820aad717fcefb34811387d57"</span>: &#123;</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"nginx.1.5nhg56y2vohlevb6p4a1xuwjq"</span>,</span><br><span class="line">                <span class="string">"EndpointID"</span>: <span class="string">"f33f63c27b2d75fa7272e57fb193e291dab588a6f7fc51f0e508b7caf8bb36b2"</span>,</span><br><span class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:0a:ff:00:05"</span>,</span><br><span class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"10.255.0.5/16"</span>,</span><br><span class="line">                <span class="string">"IPv6Address"</span>: <span class="string">""</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"8b4cd33138e9c9262b31a70ba0103535c6a3828b45f3dc6eb9a5ee5c07c07e29"</span>: &#123;</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"nginx.2.8uu9u366fqpda3vm69dzdfr1z"</span>,</span><br><span class="line">                <span class="string">"EndpointID"</span>: <span class="string">"e73c1b17fe8a5ee98081a33d70abada0852cadd553912504713795059080dd07"</span>,</span><br><span class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:0a:ff:00:06"</span>,</span><br><span class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"10.255.0.6/16"</span>,</span><br><span class="line">                <span class="string">"IPv6Address"</span>: <span class="string">""</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"8b4cd33138e9c9262b31a70ba0103535c6a3828b45f3dc6eb9a5ee5c07c07e29"</span>: &#123;</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"nginx.2.41to6h36vp1i31qad79iiz2qf"</span>,</span><br><span class="line">                <span class="string">"EndpointID"</span>: <span class="string">"745c0806c4f75ee98081a33d70g930s0852cadd55391204713798b4cd33138e9"</span>,</span><br><span class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:0a:ff:00:06"</span>,</span><br><span class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"10.255.0.7/16"</span>,</span><br><span class="line">                <span class="string">"IPv6Address"</span>: <span class="string">""</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"ingress-sbox"</span>: &#123;</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"ingress-endpoint"</span>,</span><br><span class="line">                <span class="string">"EndpointID"</span>: <span class="string">"7e9a378dcfeed25805bd7ea78e411df39b06aa9ad347bb6ff0b3fe86f09d44bb"</span>,</span><br><span class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:0a:ff:00:03"</span>,</span><br><span class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"10.255.0.3/16"</span>,</span><br><span class="line">                <span class="string">"IPv6Address"</span>: <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Options"</span>: &#123;</span><br><span class="line">            <span class="string">"com.docker.network.driver.overlay.vxlanid_list"</span>: <span class="string">"256"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Labels"</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>ingress-sbox というコンテナがある。</p>
<p>workerのiptablesを確認</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker1</span></span><br><span class="line"></span><br><span class="line">sudo iptables-save | grep INGRESS</span><br><span class="line">:DOCKER-INGRESS - [0:0]</span><br><span class="line">-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER-INGRESS</span><br><span class="line">-A OUTPUT -m addrtype --dst-type LOCAL -j DOCKER-INGRESS</span><br><span class="line">-A DOCKER-INGRESS -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.18.0.2:80</span><br><span class="line">-A DOCKER-INGRESS -j RETURN</span><br></pre></td></tr></table></figure>
<p>DNATの設定がある。80ポートで受けたリクエストを 172.18.0.2:80 に転送している。<br>この172.18.0.2がingressネットワーク。しかし、172.18.0.2はdockerのコンテナとしてはリストアップされない。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker1</span></span><br><span class="line"></span><br><span class="line">ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: dummy0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ether ca:f2:56:e6:fe:34 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:25:2e:6a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.2.15/24 brd 10.0.2.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::a00:27ff:fe25:2e6a/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:87:c3:c8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.99.104/24 brd 192.168.99.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::a00:27ff:fe87:c3c8/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">6: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:00:44:03:63 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:60:28:a7:82 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.1/16 scope global docker_gwbridge</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:60ff:fe28:a782/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">13: vethff5efce@if12: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP group default</span><br><span class="line">    link/ether 32:4b:45:f2:fa:8c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::304b:45ff:fef2:fa8c/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">18: vethabbd231@if17: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP group default</span><br><span class="line">    link/ether f6:c9:ed:48:b7:29 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::f4c9:edff:fe48:b729/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>ルーティングもみてみる</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker1</span></span><br><span class="line"></span><br><span class="line">ip route</span><br><span class="line">default via 10.0.2.2 dev eth0  metric 1</span><br><span class="line">10.0.2.0/24 dev eth0  proto kernel  scope link  src 10.0.2.15</span><br><span class="line">127.0.0.1 dev lo  scope link</span><br><span class="line">172.17.0.0/16 dev docker0  proto kernel  scope link  src 172.17.0.1</span><br><span class="line">172.18.0.0/16 dev docker_gwbridge  proto kernel  scope link  src 172.18.0.1</span><br><span class="line">192.168.99.0/24 dev eth1  proto kernel  scope link  src 192.168.99.104</span><br></pre></td></tr></table></figure>
<p>どうやらdocker_gwbridgeのもののようだ。managerでも同様にdocker_gwbridgeなるものがあることから、<br>docker_gwbridgeは作成したネットワークに属するnodeすべてに共通で利用されている。<br>ということで、外部からのアクセスにはdocker_gwbridgeを使用している。</p>
<p>ということで、コンテナ間でも通信できるはず。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker1</span></span><br><span class="line"></span><br><span class="line">ping -c 4 192.168.99.100</span><br><span class="line">PING 192.168.99.100 (192.168.99.100): 56 data bytes</span><br><span class="line">64 bytes from 192.168.99.100: seq=0 ttl=64 time=0.459 ms</span><br><span class="line">64 bytes from 192.168.99.100: seq=1 ttl=64 time=0.357 ms</span><br><span class="line">64 bytes from 192.168.99.100: seq=2 ttl=64 time=0.439 ms</span><br><span class="line">64 bytes from 192.168.99.100: seq=3 ttl=64 time=0.374 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.99.100 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.357/0.407/0.459 ms</span><br></pre></td></tr></table></figure>
<h2 id="サービス作成"><a href="#サービス作成" class="headerlink" title="サービス作成"></a>サービス作成</h2><p>swarm modeでコンテナを起動するためのserviceを作成する。作成されたnodeをタスクという。<br>–replicasフラグでtask数を指定して作成する。<br>今回はnginxのサービスを作成する。</p>
<p>nginx というサービスを作成し、testnetworkでswarmのポート80をコンテナのポート80に割り当て。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker service create --name nginx --replicas 3 --network testnetwork -p 80:80/tcp nginx</span><br><span class="line">cz4kot5ft0hz8v9euubq75ja2</span><br></pre></td></tr></table></figure>
<p>作成されたサービスの確認</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker service ls</span><br><span class="line">ID            NAME   REPLICAS  IMAGE  COMMAND</span><br><span class="line">cz4kot5ft0hz  nginx  0/3       nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># --pretty で見やすく表示</span></span><br><span class="line">docker service inspect --pretty nginx</span><br><span class="line">ID:     cz4kot5ft0hz8v9euubq75ja2</span><br><span class="line">Name:       nginx</span><br><span class="line">Mode:       Replicated</span><br><span class="line"> Replicas:  3</span><br><span class="line">Placement:</span><br><span class="line">UpdateConfig:</span><br><span class="line"> Parallelism:   1</span><br><span class="line"> On failure:    pause</span><br><span class="line">ContainerSpec:</span><br><span class="line"> Image:     nginx</span><br><span class="line">Resources:</span><br><span class="line">Networks: 0s19bsmqf8wcblaur5ryb8biqPorts:</span><br><span class="line"> Protocol = tcp</span><br><span class="line"> TargetPort = 80</span><br><span class="line"> PublishedPort = 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginxのイメージ取得中でpreparingになっている</span></span><br><span class="line">docker service ps nginx</span><br><span class="line">ID                         NAME     IMAGE  NODE     DESIRED STATE  CURRENT STATE                 ERROR</span><br><span class="line">5nhg56y2vohlevb6p4a1xuwjq  nginx.1  nginx  worker2  Running        Running 3 seconds ago</span><br><span class="line">8uu9u366fqpda3vm69dzdfr1z  nginx.2  nginx  worker1  Running        Preparing about a minute ago</span><br><span class="line">41to6h36vp1i31qad79iiz2qf  nginx.3  nginx  manager  Running        Preparing about a minute ago</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再度実行する</span></span><br><span class="line">docker service ps nginx</span><br><span class="line">ID                         NAME     IMAGE  NODE     DESIRED STATE  CURRENT STATE          ERROR</span><br><span class="line">5nhg56y2vohlevb6p4a1xuwjq  nginx.1  nginx  worker2  Running        Running 2 minutes ago</span><br><span class="line">8uu9u366fqpda3vm69dzdfr1z  nginx.2  nginx  worker1  Running        Running 2 minutes ago</span><br><span class="line">41to6h36vp1i31qad79iiz2qf  nginx.3  nginx  manager  Running        Running 2 minutes ago</span><br></pre></td></tr></table></figure>
<p>curl を実行して起動していることを確認</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.99.100</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="サービスのスケールアップ・スケールダウン"><a href="#サービスのスケールアップ・スケールダウン" class="headerlink" title="サービスのスケールアップ・スケールダウン"></a>サービスのスケールアップ・スケールダウン</h2><p>スケールアップしてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker service scale nginx=4</span><br><span class="line">nginx scaled to 4</span><br><span class="line"></span><br><span class="line">docker service ps nginx</span><br><span class="line">ID                         NAME     IMAGE  NODE     DESIRED STATE  CURRENT STATE          ERROR</span><br><span class="line">5nhg56y2vohlevb6p4a1xuwjq  nginx.1  nginx  worker2  Running        Running 6 minutes ago</span><br><span class="line">8uu9u366fqpda3vm69dzdfr1z  nginx.2  nginx  worker1  Running        Running 6 minutes ago</span><br><span class="line">41to6h36vp1i31qad79iiz2qf  nginx.3  nginx  manager  Running        Running 6 minutes ago</span><br><span class="line">bn0kohl7ecfcmwoeksy6cowdf  nginx.4  nginx  worker1  Running        Running 4 seconds ago</span><br></pre></td></tr></table></figure>
<p>タスクが4個あることがわかる。<br>続いてスケールダウンする。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker service scale nginx=3</span><br><span class="line">nginx scaled to 3</span><br><span class="line"></span><br><span class="line">docker service ps nginx</span><br><span class="line">ID                         NAME     IMAGE  NODE     DESIRED STATE  CURRENT STATE                    ERROR</span><br><span class="line">5nhg56y2vohlevb6p4a1xuwjq  nginx.1  nginx  worker2  Running        Running 7 minutes ago</span><br><span class="line">8uu9u366fqpda3vm69dzdfr1z  nginx.2  nginx  worker1  Running        Running 7 minutes ago</span><br><span class="line">41to6h36vp1i31qad79iiz2qf  nginx.3  nginx  manager  Running        Running 7 minutes ago</span><br><span class="line">bn0kohl7ecfcmwoeksy6cowdf  nginx.4  nginx  worker1  Shutdown       Shutdown less than a second ago</span><br><span class="line"></span><br><span class="line">docker service ps nginx</span><br><span class="line">ID                         NAME     IMAGE  NODE     DESIRED STATE  CURRENT STATE           ERROR</span><br><span class="line">5nhg56y2vohlevb6p4a1xuwjq  nginx.1  nginx  worker2  Running        Running 7 minutes ago</span><br><span class="line">8uu9u366fqpda3vm69dzdfr1z  nginx.2  nginx  worker1  Running        Running 7 minutes ago</span><br><span class="line">41to6h36vp1i31qad79iiz2qf  nginx.3  nginx  manager  Running        Running 7 minutes ago</span><br><span class="line">bn0kohl7ecfcmwoeksy6cowdf  nginx.4  nginx  worker1  Shutdown       Shutdown 3 seconds ago</span><br></pre></td></tr></table></figure>
<p>タスクが3つに戻った。</p>
<h2 id="自動復旧"><a href="#自動復旧" class="headerlink" title="自動復旧"></a>自動復旧</h2><p>worker2のコンテナをstopして、タスクが自動で復旧することを確認する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker2</span></span><br><span class="line"></span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">55ce84f00f26        nginx:latest        <span class="string">"nginx -g 'daemon off"</span>   49 seconds ago      Up 48 seconds       80/tcp, 443/tcp     nginx.1.160s9norhjlicvlvrpymar0yz</span><br><span class="line"></span><br><span class="line">docker stop 55ce84f00f26</span><br><span class="line">55ce84f00f26</span><br><span class="line"></span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE</span><br></pre></td></tr></table></figure>
<p>stopしたこと確認した。しばらくすると自動でコンテナが起動</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker2</span></span><br><span class="line"></span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">6c3d900cb9fe        nginx:latest        <span class="string">"nginx -g 'daemon off"</span>   21 seconds ago      Up 19 seconds       80/tcp, 443/tcp     nginx.1.adgxpo8s9ki82sz3rel26g9cb</span><br></pre></td></tr></table></figure>
<p>タスクは3つになっている。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker service ps nginx</span><br><span class="line">ID                         NAME         IMAGE  NODE     DESIRED STATE  CURRENT STATE               ERROR</span><br><span class="line">adgxpo8s9ki82sz3rel26g9cb  nginx.1      nginx  worker2  Running        Running 45 seconds ago</span><br><span class="line">160s9norhjlicvlvrpymar0yz   \_ nginx.1  nginx  worker2  Shutdown       Complete 51 seconds ago</span><br><span class="line">ci5qqrgppuxvqub8bos8j3dhg  nginx.2      nginx  worker1  Running        Running about a minute ago</span><br><span class="line">bngsjgp2o4tdvczrc623wk7x2  nginx.3      nginx  manager  Running        Running 19 seconds ago</span><br></pre></td></tr></table></figure>
<h2 id="ローリング・アップデート"><a href="#ローリング・アップデート" class="headerlink" title="ローリング・アップデート"></a>ローリング・アップデート</h2><p>実行中のイメージを差し替えたり、アップデートする際に使う。<br>起動中のコンテナの停止、イメージの取得し起動までを自動で行う。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --update-delay イメージ更新までの遅延時間</span></span><br><span class="line"><span class="comment"># --update-parallelism 同時に更新するtaskの最大数</span></span><br><span class="line">docker service update --update-delay 10s --update-parallelism 1 --image nginx:latest nginx</span><br><span class="line">nginx</span><br><span class="line"></span><br><span class="line">docker service ls</span><br><span class="line">ID            NAME   REPLICAS  IMAGE         COMMAND</span><br><span class="line">4cut0umrm3a3  nginx  2/3       nginx:latest</span><br><span class="line"></span><br><span class="line">docker service ps nginx</span><br><span class="line">ID                         NAME         IMAGE         NODE     DESIRED STATE  CURRENT STATE            ERROR</span><br><span class="line">dzyijvwet9pjz8ac9m65ye4id  nginx.1      nginx:latest  worker2  Running        Running 28 seconds ago</span><br><span class="line">adgxpo8s9ki82sz3rel26g9cb   \_ nginx.1  nginx         worker2  Shutdown       Shutdown 31 seconds ago</span><br><span class="line">160s9norhjlicvlvrpymar0yz   \_ nginx.1  nginx         worker2  Shutdown       Complete 9 minutes ago</span><br><span class="line">bgsr4e1yd8c0q9nyl0wylp3ky  nginx.2      nginx:latest  worker2  Running        Preparing 2 seconds ago</span><br><span class="line">ci5qqrgppuxvqub8bos8j3dhg   \_ nginx.2  nginx         worker1  Shutdown       Shutdown 2 seconds ago</span><br><span class="line">9tt8df7zjj65tgp9l6yx4engd  nginx.3      nginx:latest  manager  Running        Running 13 seconds ago</span><br><span class="line">bngsjgp2o4tdvczrc623wk7x2   \_ nginx.3  nginx         manager  Shutdown       Shutdown 16 seconds ago</span><br></pre></td></tr></table></figure>
<h2 id="drain-解放"><a href="#drain-解放" class="headerlink" title="drain(解放)"></a>drain(解放)</h2><p>メンテナンスなどでnodeを個別に切り離す必要があるときなどに、一時的にクラスタから解放する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">docker node inspect --pretty worker1</span><br><span class="line">ID:         cwdb1t7e3o9rstaiudaxswzu9</span><br><span class="line">Hostname:       worker1</span><br><span class="line">Status:</span><br><span class="line"> State:         Ready</span><br><span class="line"> Availability:      Active</span><br><span class="line">Platform:</span><br><span class="line"> Operating System:  linux</span><br><span class="line"> Architecture:      x86_64</span><br><span class="line">Resources:</span><br><span class="line"> CPUs:          1</span><br><span class="line"> Memory:        995.9 MiB</span><br><span class="line">Plugins:</span><br><span class="line">  Network:      bridge, host, null, overlay</span><br><span class="line">  Volume:       <span class="built_in">local</span></span><br><span class="line">Engine Version:     1.12.0</span><br><span class="line">Engine Labels:</span><br><span class="line"> - provider = virtualbox%</span><br><span class="line"></span><br><span class="line">docker node update --availability drain worker1</span><br><span class="line">worker1</span><br><span class="line"></span><br><span class="line">docker node inspect --pretty worker1</span><br><span class="line">ID:         cwdb1t7e3o9rstaiudaxswzu9</span><br><span class="line">Hostname:       worker1</span><br><span class="line">Status:</span><br><span class="line"> State:         Ready</span><br><span class="line"> Availability:      Drain</span><br><span class="line">Platform:</span><br><span class="line"> Operating System:  linux</span><br><span class="line"> Architecture:      x86_64</span><br><span class="line">Resources:</span><br><span class="line"> CPUs:          1</span><br><span class="line"> Memory:        995.9 MiB</span><br><span class="line">Plugins:</span><br><span class="line">  Network:      bridge, host, null, overlay</span><br><span class="line">  Volume:       <span class="built_in">local</span></span><br><span class="line">Engine Version:     1.12.0</span><br><span class="line">Engine Labels:</span><br><span class="line"> - provider = virtualbox%</span><br><span class="line"></span><br><span class="line">docker service ps nginx</span><br><span class="line">ID                         NAME         IMAGE         NODE     DESIRED STATE  CURRENT STATE            ERROR</span><br><span class="line">4h2qkchax4m34z1pxi61nlnnh  nginx.1      nginx         manager  Running        Running 6 minutes ago</span><br><span class="line">dzyijvwet9pjz8ac9m65ye4id   \_ nginx.1  nginx:latest  worker2  Shutdown       Shutdown 6 minutes ago</span><br><span class="line">adgxpo8s9ki82sz3rel26g9cb   \_ nginx.1  nginx         worker2  Shutdown       Shutdown 31 seconds ago</span><br><span class="line">160s9norhjlicvlvrpymar0yz   \_ nginx.1  nginx         worker2  Shutdown       Complete 9 minutes ago</span><br><span class="line">bgsr4e1yd8c0q9nyl0wylp3ky  nginx.2      nginx:latest  worker2  Running        Preparing 2 seconds ago</span><br><span class="line">ci5qqrgppuxvqub8bos8j3dhg   \_ nginx.2  nginx         worker1  Shutdown       Shutdown 2 seconds ago</span><br><span class="line">9tt8df7zjj65tgp9l6yx4engd  nginx.3      nginx:latest  manager  Running        Running 13 seconds ago</span><br><span class="line">bngsjgp2o4tdvczrc623wk7x2   \_ nginx.3  nginx         manager  Shutdown       Shutdown 16 seconds ago</span><br></pre></td></tr></table></figure>
<p>worker1がdrainされてmanagerがnginx.1タスクを作成している。<br>この状態でdrainしたnodeをアクティブに戻す。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">docker node update --availability active worker1</span><br><span class="line">worker1</span><br><span class="line"></span><br><span class="line">docker node inspect --pretty worker1</span><br><span class="line">ID:         cwdb1t7e3o9rstaiudaxswzu9</span><br><span class="line">Hostname:       worker1</span><br><span class="line">Status:</span><br><span class="line"> State:         Ready</span><br><span class="line"> Availability:      Active</span><br><span class="line">Platform:</span><br><span class="line"> Operating System:  linux</span><br><span class="line"> Architecture:      x86_64</span><br><span class="line">Resources:</span><br><span class="line"> CPUs:          1</span><br><span class="line"> Memory:        995.9 MiB</span><br><span class="line">Plugins:</span><br><span class="line">  Network:      bridge, host, null, overlay</span><br><span class="line">  Volume:       <span class="built_in">local</span></span><br><span class="line">Engine Version:     1.12.0</span><br><span class="line">Engine Labels:</span><br><span class="line"> - provider = virtualbox%</span><br></pre></td></tr></table></figure>
<p>worker1が利用できる状態で待機している。<br>クラスタに追加されている。</p>
<h2 id="サービスの削除とnodeの削除"><a href="#サービスの削除とnodeの削除" class="headerlink" title="サービスの削除とnodeの削除"></a>サービスの削除とnodeの削除</h2><p>サービスの削除。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker service  ls</span><br><span class="line">ID            NAME   REPLICAS  IMAGE  COMMAND</span><br><span class="line">cz4kot5ft0hz  nginx  3/3       nginx</span><br><span class="line"></span><br><span class="line">docker service rm nginx</span><br><span class="line">nginx</span><br><span class="line"></span><br><span class="line">docker service ls</span><br><span class="line">ID  NAME  REPLICAS  IMAGE  COMMAND</span><br></pre></td></tr></table></figure>
<p>nodeをswarmから解放する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker1</span></span><br><span class="line"></span><br><span class="line">docker swarm leave</span><br><span class="line">Node left the swarm.</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@worker2</span></span><br><span class="line"></span><br><span class="line">docker swarm leave</span><br><span class="line">Node left the swarm.</span><br></pre></td></tr></table></figure>
<p>各workerがswarmから解放された。</p>
<p>最後にmanagerをswarmから解放する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker@manager</span></span><br><span class="line"></span><br><span class="line">docker swarm leave --force</span><br><span class="line">Node left the swarm.</span><br></pre></td></tr></table></figure>
<h3 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h3><p>思った以上にクラスタを容易に作成できた。<br>swarm modeはマルチホストネットワーク機能(docker_gwbridge)をつかって、<br>アプリケーションを動かすということだと再確認できた。</p>
<h3 id="参考にしたページ"><a href="#参考にしたページ" class="headerlink" title="参考にしたページ"></a>参考にしたページ</h3><p><a href="https://pocketstudio.net/2016/06/23/docker-1-12-swarm-mode-and-ingress-load-balancing/" target="_blank" rel="noopener">https://pocketstudio.net/2016/06/23/docker-1-12-swarm-mode-and-ingress-load-balancing/</a><br><a href="https://docs.docker.com/engine/userguide/networking/get-started-overlay/" target="_blank" rel="noopener">https://docs.docker.com/engine/userguide/networking/get-started-overlay/</a></p>

    
  </div>

  
    <footer class="article-footer">

      
        <aside class="google-adsence">
          
<!-- Google Adsence -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-4054575508733221"
   data-ad-slot="9493597992"
   data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- End Google Adsence -->


        </aside>
      

      <div class="share_content">
  <div class="hatena_sharebox">
    
      <a href="http://b.hatena.ne.jp/entry/blog.kazu69.net/2016/08/09/try-docker-swarm-mode/" class="hatena-bookmark-button" data-hatena-bookmark-title="docker swarm mode を試してみる" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  </div>
  
    <div class="addthis addthis_toolbox addthis_default_style">
      
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
      
      
        <a class="addthis_button_tweet"></a>
      
      
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
      
      
      <!-- <a class="addthis_counter addthis_pill_style"></a> -->
    </div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55a4f49a45ced975"></script>
  
</div>

      
        <a href="http://blog.kazu69.net/2016/08/09/try-docker-swarm-mode/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  

  
    
<nav id="article-nav">
  <div class="article-nav">
    
      <a href="/2016/08/23/target-blank-vulnerability-tabnabbing-and-countermeasures/" id="article-nav-newer" class="article-nav-link article-nav-link-newer">
        <span class="article-nav-caption">Newer - </span>
        <span class="article-nav-title">
          
            target=&quot;_blank&quot;を使った脆弱性Tabnabbingとその対策
          
        </span>
      </a>
    
    
      <a href="/2016/07/30/authenticate_with_json_web_token/" id="article-nav-older" class="article-nav-link article-nav-link-older">
        <span class="article-nav-caption">Older - </span>
        <span class="article-nav-title">
          
            JWT(JSON Web Token)を使った認証を試みる
          
        </span>
        </span>
      </a>
    
  </div>
</nav>

  
</article>


<section class="comments" id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      
    </main>
    <footer id="footer" role="contentinfo">
  
  <div class="footer-cotent">
    <small>&copy; 2019 kazu69</small>
    <span class="generator">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
  </div>
</footer>
    
<script>
  var disqus_shortname = '69log';
  
  var disqus_url = 'http://blog.kazu69.net/2016/08/09/try-docker-swarm-mode/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</body>
</html>