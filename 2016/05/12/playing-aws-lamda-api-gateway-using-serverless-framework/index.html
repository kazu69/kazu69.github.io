<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Serverless Frameworkを使ってAWS LambdaとAPI Gatewayを試した | 69log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="サーバーレスでアプリケーションを構築するためのNode.jsのフレームワークServerlessを使って、AWS LambdaとAmazon API GatewayをつかってSlack Botを試してみたときのメモ。">
<meta property="og:type" content="article">
<meta property="og:title" content="Serverless Frameworkを使ってAWS LambdaとAPI Gatewayを試した">
<meta property="og:url" content="http://blog.kazu69.net/2016/05/12/playing-aws-lamda-api-gateway-using-serverless-framework/index.html">
<meta property="og:site_name" content="69log">
<meta property="og:description" content="サーバーレスでアプリケーションを構築するためのNode.jsのフレームワークServerlessを使って、AWS LambdaとAmazon API GatewayをつかってSlack Botを試してみたときのメモ。">
<meta property="og:image" content="http://blog.kazu69.net/images/2016/05/12/serverless8.png">
<meta property="og:image" content="http://blog.kazu69.net/images/2016/05/12/serverless1.png">
<meta property="og:image" content="http://blog.kazu69.net/images/2016/05/12/serverless2.png">
<meta property="og:image" content="http://blog.kazu69.net/images/2016/05/12/serverless3.png">
<meta property="og:image" content="http://blog.kazu69.net/images/2016/05/12/serverless4.png">
<meta property="og:image" content="http://blog.kazu69.net/images/2016/05/12/serverless6.png">
<meta property="og:image" content="http://blog.kazu69.net/images/2016/05/12/serverless7.png">
<meta property="og:updated_time" content="2016-05-12T16:19:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serverless Frameworkを使ってAWS LambdaとAPI Gatewayを試した">
<meta name="twitter:description" content="サーバーレスでアプリケーションを構築するためのNode.jsのフレームワークServerlessを使って、AWS LambdaとAmazon API GatewayをつかってSlack Botを試してみたときのメモ。">
<meta name="twitter:image" content="http://blog.kazu69.net/images/2016/05/12/serverless8.png">
  
    <link rel="alternative" href="/atom.xml" title="69log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-9196861-14', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
    <header role="header">
  <div class="header cf">
    <div class="title-content">
      <h1>
        <a href="/">69log</a>
      </h1>
      
        <h2>
          <a href="/">福岡でwebの仕事をしています</a>
        </h2>
      
    </div>

    <div class="nav-content cf">
      <nav>
        
          <a href="/" class="nav-link nav-home">home</a>
        
          <a href="/archives" class="nav-link nav-archives">archives</a>
        
        
          <a href="/atom.xml" title="RSS Feed" class="icon nav-link nav-feed"></a>
        
      </nav>
      <div class="header-search">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://blog.kazu69.net"></form>
      </div>
    </div>
  </div>
</header>

    <main role="main" id="main">
      <section><article id="post-playing-aws-lamda-api-gateway-using-serverless-framework" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    
      
  
    <h1 class="article-title" itemprop="name">
      Serverless Frameworkを使ってAWS LambdaとAPI Gatewayを試した
    </h1>
  

    
    <div class="article-meta clr">
      <time datetime="2016-05-12T10:26:02.000Z" itemprop="datePublished">2016-05-12</time>

      
  <div class="article-category">
    <a class="article-category-link" href="/categories/memo/">memo</a>
  </div>


    </div>
  </header>

  <div class="article-entry" itemprop="articleBody">
    <div class="article-gallery">
      
    </div>
    
      <p>サーバーレスでアプリケーションを構築するためのNode.jsのフレームワーク<a href="">Serverless</a>を使って、<br><a href="https://aws.amazon.com/lambda/" target="_blank" rel="external">AWS Lambda</a>と<a href="https://aws.amazon.com/jp/api-gateway/" target="_blank" rel="external">Amazon API Gateway</a>をつかってSlack Botを試してみたときのメモ。</p>
<a id="more"></a>
<p>SlackのメッセージをAPI GatewayにPOSTして、AWS Lambdaで処理をして、webhookを使ってslackに投稿する。</p>
<p><img src="/images/2016/05/12/serverless8.png" alt=""></p>
<h2 id="AWS-CLIを端末-Mac-にインストールする"><a href="#AWS-CLIを端末-Mac-にインストールする" class="headerlink" title="AWS CLIを端末(Mac)にインストールする"></a>AWS CLIを端末(Mac)にインストールする</h2><p>なにはともあれ、AWSのコマンドラインインターフェイスを使うので端末にインストールする。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">curl <span class="string">"https://bootstrap.pypa.io/get-pip.py"</span> -o <span class="string">"get-pip.py"</span></div><div class="line">sudo python get-pip.py</div><div class="line"></div><div class="line">The directory <span class="string">'/Users/YOU/Library/Caches/pip/http'</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo<span class="string">'s -H flag.</span></div><div class="line">The directory '/Users/YOU/Library/Caches/pip<span class="string">' or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo'</span>s -H flag.</div><div class="line">Requirement already up-to-date: pip <span class="keyword">in</span> /Library/Python/2.7/site-packages/pip-8.1.1-py2.7.egg</div><div class="line">Collecting wheel</div><div class="line">  Downloading wheel-0.29.0-py2.py3-none-any.whl (66kB)</div><div class="line">    100% |████████████████████████████████| 71kB 1.3MB/s</div><div class="line">Installing collected packages: wheel</div><div class="line">Successfully installed wheel-0.29.0</div><div class="line"></div><div class="line">sudo pip install awscli</div><div class="line"></div><div class="line">aws configure</div><div class="line">AWS Access Key ID [None]: XXXXXXXXXXXXXXXXXXX</div><div class="line">AWS Secret Access Key [None]: xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</div><div class="line">Default region name [None]: tokyo</div><div class="line">Default output format [None]: json</div><div class="line"></div><div class="line">ls -la ~/.aws</div><div class="line">total 16</div><div class="line">-rw-------    1 YOU  staff    39  5  1 08:32 config</div><div class="line">-rw-------    1 YOU  staff   116  5  1 08:32 credentials</div></pre></td></tr></table></figure>
<h2 id="IAM-Identity-and-Access-Management-ユーザーとポリシーの作成"><a href="#IAM-Identity-and-Access-Management-ユーザーとポリシーの作成" class="headerlink" title="IAM(Identity and Access Management)ユーザーとポリシーの作成"></a>IAM(Identity and Access Management)ユーザーとポリシーの作成</h2><p>AWSのダッシュボードの <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="external">IAM</a> からユーザーを作成する。<br>今回は<code>serverless-admin</code> という名前で作成する。</p>
<p><img src="/images/2016/05/12/serverless1.png" alt=""></p>
<p>認証情報は後ほど必要なので認証情報はダウンロードしておく。</p>
<p><img src="/images/2016/05/12/serverless2.png" alt=""></p>
<p>続いてポリシーをアタッチする。</p>
<p>IAMページのポリシーを選択し、<code>AdministratorAccess</code> を選んでアタッチする。</p>
<p><img src="/images/2016/05/12/serverless3.png" alt=""></p>
<p><img src="/images/2016/05/12/serverless4.png" alt=""></p>
<h2 id="Serverlessのインストールとプロジェクト作成"><a href="#Serverlessのインストールとプロジェクト作成" class="headerlink" title="Serverlessのインストールとプロジェクト作成"></a>Serverlessのインストールとプロジェクト作成</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">node -v</div><div class="line">v5.10.1</div><div class="line"></div><div class="line">npm i -g serverless</div><div class="line"></div><div class="line">serverless</div><div class="line"> _______                             __</div><div class="line">|   _   .-----.----.--.--.-----.----|  .-----.-----.-----.</div><div class="line">|   |___|  -__|   _|  |  |  -__|   _|  |  -__|__ --|__ --|</div><div class="line">|____   |_____|__|  \___/|_____|__| |__|_____|_____|_____|</div><div class="line">|   |   |             The Serverless Application Framework</div><div class="line">|       |                           serverless.com, v0.5.5</div><div class="line">`-------<span class="string">'</span></div><div class="line"></div><div class="line">Commands</div><div class="line">* Serverless documentation: http://docs.serverless.com</div><div class="line">* You can run commands with "serverless" or the shortcut "sls"</div><div class="line">* Pass "--help" after any &lt;context&gt; &lt;action&gt; for contextual help</div><div class="line"></div><div class="line">"project" actions:</div><div class="line">  create</div><div class="line">  install</div><div class="line">  init</div><div class="line">  remove</div><div class="line"></div><div class="line">"function" actions:</div><div class="line">  run</div><div class="line">  create</div><div class="line">  deploy</div><div class="line">  logs</div><div class="line">  remove</div><div class="line">  rollback</div><div class="line"></div><div class="line">"endpoint" actions:</div><div class="line">  deploy</div><div class="line">  remove</div><div class="line"></div><div class="line">"event" actions:</div><div class="line">  deploy</div><div class="line">  remove</div><div class="line"></div><div class="line">"dash" actions:</div><div class="line">  deploy</div><div class="line">  summary</div><div class="line"></div><div class="line">"stage" actions:</div><div class="line">  create</div><div class="line">  remove</div><div class="line"></div><div class="line">"region" actions:</div><div class="line">  create</div><div class="line">  remove</div><div class="line"></div><div class="line">"resources" actions:</div><div class="line">  deploy</div><div class="line">  remove</div><div class="line">  diff</div><div class="line"></div><div class="line">"plugin" actions:</div><div class="line">  create</div><div class="line"></div><div class="line">"variables" actions:</div><div class="line">  list</div><div class="line">  set</div><div class="line">  unset</div></pre></td></tr></table></figure>
<p>You can run commands with “serverless” or the shortcut “sls” とあるように<br><code>serverless</code>は<code>sls</code>でaliasされているとのこと。</p>
<p>つづいて、プロジェクトの作成を行う。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">sls project init</div><div class="line"> _______                             __</div><div class="line">|   _   .-----.----.--.--.-----.----|  .-----.-----.-----.</div><div class="line">|   |___|  -__|   _|  |  |  -__|   _|  |  -__|__ --|__ --|</div><div class="line">|____   |_____|__|  \___/|_____|__| |__|_____|_____|_____|</div><div class="line">|   |   |             The Serverless Application Framework</div><div class="line">|       |                           serverless.com, v0.5.5</div><div class="line">`-------<span class="string">'</span></div><div class="line"></div><div class="line">Serverless: Initializing Serverless Project...</div><div class="line">Serverless: Enter a name for this project:  (serverless-b1ntox) serverless-greeints</div><div class="line">Serverless: Enter a new stage name for this project:  (dev)</div><div class="line">Serverless: For the "dev" stage, do you want to use an existing Amazon Web Services profile or create a new one?</div><div class="line">  &gt; Existing Profile</div><div class="line">    Create A New Profile</div><div class="line">Serverless: Select a profile for your project:</div><div class="line">  &gt; default</div><div class="line">Serverless: Creating stage "dev"...</div><div class="line">Serverless: Select a new region for your stage:</div><div class="line">    us-east-1</div><div class="line">    us-west-2</div><div class="line">  &gt; eu-west-1</div><div class="line">    eu-central-1</div><div class="line">    ap-northeast-1</div><div class="line">Serverless: Creating region "eu-west-1" in stage "dev"...</div><div class="line">Serverless: Deploying resources to stage "dev" in region "eu-west-1" via Cloudformation (~3 minutes)...</div><div class="line">Serverless: Successfully deployed "dev" resources to "eu-west-1"</div><div class="line">Serverless: Successfully created region "eu-west-1" within stage "dev"</div><div class="line">Serverless: Successfully created stage "dev"</div><div class="line">Serverless: Successfully initialized project "serverless-greeints"</div></pre></td></tr></table></figure>
<p>プロジェクトを作成すると以下のようになる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">tree -L 2</div><div class="line">.</div><div class="line">│ </div><div class="line">└── serverless-greeints</div><div class="line">      ├── _meta</div><div class="line">      │   ├── resources</div><div class="line">      │   └── variables</div><div class="line">      ├── admin.env</div><div class="line">      ├── package.json</div><div class="line">      ├── s-project.json</div><div class="line">      └── s-resources-cf.json</div></pre></td></tr></table></figure>
<p>プロジェクト毎に次のような<code>s-project.json</code>が作成される。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"serverless-greeints"</span>,</div><div class="line">  <span class="string">"custom"</span>: &#123;&#125;,</div><div class="line">  <span class="string">"plugins"</span>: []</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>admin.env</code>にはAWSのAccess Keysのパスが書き込まれる。<br>初期値はdefaultとなり、$HOME/.awsを参照する。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AWS_DEV_PROFILE=default</div></pre></td></tr></table></figure>
<p><code>_meta/variables</code>にはプロジェクトごとのstageやregionなどの設定ファイルがjsonで保持されている。<br>たとえばstateがdev、reagionがus:westなら該当する設定ファイルは<code>s-variables-dev-uswest.json</code>となる。</p>
<p><code>s-resources-cf.json</code>はCloudFormationのテンプレートファイル。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"AWSTemplateFormatVersion"</span>: <span class="string">"2010-09-09"</span>,</div><div class="line">  <span class="string">"Description"</span>: <span class="string">"The AWS CloudFormation template for this Serverless application's resources outside of Lambdas and Api Gateway"</span>,</div><div class="line">  <span class="string">"Resources"</span>: &#123;</div><div class="line">    <span class="string">"IamRoleLambda"</span>: &#123;</div><div class="line">      <span class="string">"Type"</span>: <span class="string">"AWS::IAM::Role"</span>,</div><div class="line">      <span class="string">"Properties"</span>: &#123;</div><div class="line">        <span class="string">"AssumeRolePolicyDocument"</span>: &#123;</div><div class="line">          <span class="string">"Version"</span>: <span class="string">"2012-10-17"</span>,</div><div class="line">          <span class="string">"Statement"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="string">"Effect"</span>: <span class="string">"Allow"</span>,</div><div class="line">              <span class="string">"Principal"</span>: &#123;</div><div class="line">                <span class="string">"Service"</span>: [</div><div class="line">                  <span class="string">"lambda.amazonaws.com"</span></div><div class="line">                ]</div><div class="line">              &#125;,</div><div class="line">              <span class="string">"Action"</span>: [</div><div class="line">                <span class="string">"sts:AssumeRole"</span></div><div class="line">              ]</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"Path"</span>: <span class="string">"/"</span></div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"IamPolicyLambda"</span>: &#123;</div><div class="line">      <span class="string">"Type"</span>: <span class="string">"AWS::IAM::Policy"</span>,</div><div class="line">      <span class="string">"Properties"</span>: &#123;</div><div class="line">        <span class="string">"PolicyName"</span>: <span class="string">"$&#123;stage&#125;-$&#123;project&#125;-lambda"</span>,</div><div class="line">        <span class="string">"PolicyDocument"</span>: &#123;</div><div class="line">          <span class="string">"Version"</span>: <span class="string">"2012-10-17"</span>,</div><div class="line">          <span class="string">"Statement"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="string">"Effect"</span>: <span class="string">"Allow"</span>,</div><div class="line">              <span class="string">"Action"</span>: [</div><div class="line">                <span class="string">"logs:CreateLogGroup"</span>,</div><div class="line">                <span class="string">"logs:CreateLogStream"</span>,</div><div class="line">                <span class="string">"logs:PutLogEvents"</span></div><div class="line">              ],</div><div class="line">              <span class="string">"Resource"</span>: <span class="string">"arn:aws:logs:$&#123;region&#125;:*:*"</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"Roles"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="string">"Ref"</span>: <span class="string">"IamRoleLambda"</span></div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"Outputs"</span>: &#123;</div><div class="line">    <span class="string">"IamRoleArnLambda"</span>: &#123;</div><div class="line">      <span class="string">"Description"</span>: <span class="string">"ARN of the lambda IAM role"</span>,</div><div class="line">      <span class="string">"Value"</span>: &#123;</div><div class="line">        <span class="string">"Fn::GetAtt"</span>: [</div><div class="line">          <span class="string">"IamRoleLambda"</span>,</div><div class="line">          <span class="string">"Arn"</span></div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>_meta</code>ディレクトリはデフォルトで作成される.gitignoreに記載されているため、基本的にgit管理されないようになっている。</p>
<h2 id="functionを触ってみる"><a href="#functionを触ってみる" class="headerlink" title="functionを触ってみる"></a>functionを触ってみる</h2><p>API Gateway、Lambdaで実行されるfunctionを作成します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> serverless-greeints</div><div class="line">sls <span class="keyword">function</span> create <span class="built_in">functions</span>/hello</div><div class="line">Serverless: Please, select a runtime <span class="keyword">for</span> this new Function</div><div class="line">    nodejs4.3</div><div class="line">    python2.7</div><div class="line">  &gt; nodejs (v0.10, soon to be deprecated)</div><div class="line">Serverless: For this new Function, would you like to create an Endpoint, Event, or just the Function?</div><div class="line">  &gt; Create Endpoint</div><div class="line">    Create Event</div><div class="line">    Just the Function...</div><div class="line">Serverless: Successfully created <span class="keyword">function</span>: <span class="string">"functions/hello"</span></div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">tree -L 2 <span class="built_in">functions</span></div><div class="line"><span class="built_in">functions</span></div><div class="line">└── hello</div><div class="line">    ├── event.json</div><div class="line">    ├── handler.js</div><div class="line">    └── s-function.json</div></pre></td></tr></table></figure>
<p>Amazon API Gatewayのマッピングテンプレートとなるs-function.jsonは以下のようになる。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"hello"</span>,</div><div class="line">  <span class="string">"runtime"</span>: <span class="string">"nodejs"</span>,</div><div class="line">  <span class="string">"description"</span>: <span class="string">"Serverless Lambda function for project: serverless-greeints"</span>,</div><div class="line">  <span class="string">"customName"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"customRole"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"handler"</span>: <span class="string">"handler.handler"</span>,</div><div class="line">  <span class="string">"timeout"</span>: <span class="number">6</span>,</div><div class="line">  <span class="string">"memorySize"</span>: <span class="number">1024</span>,</div><div class="line">  <span class="string">"authorizer"</span>: &#123;&#125;,</div><div class="line">  <span class="string">"custom"</span>: &#123;</div><div class="line">    <span class="string">"excludePatterns"</span>: []</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"endpoints"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"path"</span>: <span class="string">"hello"</span>,</div><div class="line">      <span class="string">"method"</span>: <span class="string">"GET"</span>,</div><div class="line">      <span class="string">"type"</span>: <span class="string">"AWS"</span>,</div><div class="line">      <span class="string">"authorizationType"</span>: <span class="string">"none"</span>,</div><div class="line">      <span class="string">"authorizerFunction"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="string">"apiKeyRequired"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="string">"requestParameters"</span>: &#123;&#125;,</div><div class="line">      <span class="string">"requestTemplates"</span>: &#123;</div><div class="line">        <span class="string">"application/json"</span>: <span class="string">""</span></div><div class="line">      &#125;,</div><div class="line">      <span class="string">"responses"</span>: &#123;</div><div class="line">        <span class="string">"400"</span>: &#123;</div><div class="line">          <span class="string">"statusCode"</span>: <span class="string">"400"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"default"</span>: &#123;</div><div class="line">          <span class="string">"statusCode"</span>: <span class="string">"200"</span>,</div><div class="line">          <span class="string">"responseParameters"</span>: &#123;&#125;,</div><div class="line">          <span class="string">"responseModels"</span>: &#123;</div><div class="line">            <span class="string">"application/json;charset=UTF-8"</span>: <span class="string">"Empty"</span></div><div class="line">          &#125;,</div><div class="line">          <span class="string">"responseTemplates"</span>: &#123;</div><div class="line">            <span class="string">"application/json;charset=UTF-8"</span>: <span class="string">""</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="string">"events"</span>: [],</div><div class="line">  <span class="string">"environment"</span>: &#123;</div><div class="line">    <span class="string">"SERVERLESS_PROJECT"</span>: <span class="string">"$&#123;project&#125;"</span>,</div><div class="line">    <span class="string">"SERVERLESS_STAGE"</span>: <span class="string">"$&#123;stage&#125;"</span>,</div><div class="line">    <span class="string">"SERVERLESS_REGION"</span>: <span class="string">"$&#123;region&#125;"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"vpc"</span>: &#123;</div><div class="line">    <span class="string">"securityGroupIds"</span>: [],</div><div class="line">    <span class="string">"subnetIds"</span>: []</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>実際にfunctionを実行する。</p>
<p>ここは本来はAPI Gateway側で実行されるのだが、Serverlessではローカルとリーモートどちらでも手元から実行できるようになっている。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># stageを選択してないのでlocalで実行</span></div><div class="line">sls <span class="keyword">function</span> run hello</div><div class="line">Serverless: Running hello...</div><div class="line">Serverless: -----------------</div><div class="line">Serverless: Success! - This Response Was Returned:</div><div class="line">Serverless: &#123;</div><div class="line">    <span class="string">"message"</span>: <span class="string">"Go Serverless! Your Lambda function executed successfully!"</span></div><div class="line"></div><div class="line"><span class="comment"># stageを選択してdeployed stageで実行</span></div><div class="line">sls <span class="keyword">function</span> run hello <span class="_">-s</span> dev</div><div class="line">Serverless: Running hello...</div><div class="line">Serverless: WARNING: This variable is not defined: region</div><div class="line">Serverless: -----------------</div><div class="line">Serverless: Success! - This Response Was Returned:</div><div class="line">Serverless: &#123;</div><div class="line">    <span class="string">"message"</span>: <span class="string">"Go Serverless! Your Lambda function executed successfully!"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>試したところで、AWSにデプロイする。<br>今回はダッシュボードとなる<code>dash</code>をデプロイする。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"> sls dash deploy</div><div class="line"> _______                             __</div><div class="line">|   _   .-----.----.--.--.-----.----|  .-----.-----.-----.</div><div class="line">|   |___|  -__|   _|  |  |  -__|   _|  |  -__|__ --|__ --|</div><div class="line">|____   |_____|__|  \___/|_____|__| |__|_____|_____|_____|</div><div class="line">|   |   |             The Serverless Application Framework</div><div class="line">|       |                           serverless.com, v0.5.5</div><div class="line">`-------<span class="string">'</span></div><div class="line"></div><div class="line">Use the &lt;up&gt;, &lt;down&gt;, &lt;pageup&gt;, &lt;pagedown&gt;, &lt;home&gt;, and &lt;end&gt; keys to navigate.</div><div class="line">Press &lt;enter&gt; to select/deselect, or &lt;space&gt; to select/deselect and move down.</div><div class="line">Press &lt;ctrl&gt; + a to select all, and &lt;ctrl&gt; + d to deselect all.</div><div class="line">Press &lt;ctrl&gt; + f to select all functions, and &lt;ctrl&gt; + e to select all endpoints.</div><div class="line">Press &lt;ctrl&gt; + &lt;enter&gt; to immediately deploy selected.</div><div class="line">Press &lt;escape&gt; to cancel.</div><div class="line"></div><div class="line"></div><div class="line">Serverless: Select the assets you wish to deploy:</div><div class="line">    hello</div><div class="line">      function - hello</div><div class="line">      endpoint - hello - GET</div><div class="line">    - - - - -</div><div class="line">  &gt; Deploy</div><div class="line">    Cancel</div><div class="line"></div><div class="line">Serverless: Deploying the specified functions in "dev" to the following regions: eu-west-1</div><div class="line">Serverless: ------------------------</div><div class="line">Serverless: Successfully deployed the following functions in "dev" to the following regions:</div><div class="line">Serverless: eu-west-1 ------------------------</div><div class="line">Serverless:   hello (serverless-greeints-hello): arn:aws:lambda:eu-west-1:0000000000:function:serverless-greeints-hello:dev</div><div class="line"></div><div class="line">Serverless: Deploying endpoints in "dev" to the following regions: eu-west-1</div><div class="line">Serverless: Successfully deployed endpoints in "dev" to the following regions:</div><div class="line">Serverless: eu-west-1 ------------------------</div><div class="line">Serverless:   GET - hello - https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello</div></pre></td></tr></table></figure>
<p>最後のエンドポイントが表示されているので、実際にリクエストしてみる。<br>レスポンスが帰って来ればOK。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello</div><div class="line">&#123;<span class="string">"message"</span>:<span class="string">"Go Serverless! Your Lambda function executed successfully!"</span>&#125;</div></pre></td></tr></table></figure>
<h3 id="functionを編集する"><a href="#functionを編集する" class="headerlink" title="functionを編集する"></a>functionを編集する</h3><p>一通り触ってみたので、実際にfunctionを編集していく。<br>まず<code>s-functions.json</code>を以下のように変更する。<br>ちなみにAPI Gatewayでは<a href="http://velocity.apache.org/engine/devel/vtl-reference-guide.html" target="_blank" rel="external">VTL(Velocity Template Language)記法</a>が使われる。</p>
<p>マッピングに使用できる変数などは<a href="http://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html" target="_blank" rel="external">マッピングテンプレートリファレンス</a>にまとまっている。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="deletion">-      "requestTemplates": &#123;&#125;,</span></div><div class="line"><span class="addition">+      "requestTemplates": &#123;</span></div><div class="line"><span class="addition">+        "application/json": "&#123;\"message\": \"$input.params('message')\"&#125;"</span></div><div class="line"><span class="addition">+      &#125;,</span></div></pre></td></tr></table></figure>
<p>これでjson形式のリクエストで<code>message</code>を受け取ることができる。</p>
<p>Lambdaで実行する処理を書いていく。</p>
<p>handler.jsを編集する。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports.handler = <span class="function"><span class="keyword">function</span>(<span class="params">event, context</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> message = event.message || <span class="string">'Good bye'</span>;</div><div class="line">  <span class="keyword">return</span> context.done(<span class="literal">null</span>, &#123;</div><div class="line">    <span class="attr">message</span>: <span class="string">'Hello '</span> + message + <span class="string">' !'</span></div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>単純にリクエストを待ち受けて、簡単なメッセージを返す。<br>先ほど<code>requestTemplates</code>を修正したので、<code>message</code>を受け取ることができる。</p>
<p>手元でfunctionを実行する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sls <span class="keyword">function</span> run hello</div><div class="line">Serverless: Running hello...</div><div class="line">Serverless: -----------------</div><div class="line">Serverless: Success! - This Response Was Returned:</div><div class="line">Serverless: &#123;</div><div class="line">    <span class="string">"message"</span>: <span class="string">"Hello Good bye !"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>また、リクエストされる<code>message</code>を渡してfunctionを実行するには、<br>event.jsonにリクエストを追加する。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="string">"message"</span>: <span class="string">"World"</span> &#125;</div></pre></td></tr></table></figure>
<p>再度、ローカルでfunctionを実行する。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sls <span class="keyword">function</span> run hello</div><div class="line">Serverless: Running hello...</div><div class="line">Serverless: -----------------</div><div class="line">Serverless: Success! - This Response Was Returned:</div><div class="line">Serverless: &#123;</div><div class="line">    <span class="string">"message"</span>: <span class="string">"Hello World !"</span></div></pre></td></tr></table></figure>
<p>想定した動きとなったので、実際にfunctionをAWS側にデプロイする。<br>ちなみに今回も<code>dash</code>(ダッシュボード)をデプロイしているが、<code>endpoint</code>のみでも良い。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">sls dash deploy</div><div class="line"> _______                             __</div><div class="line">|   _   .-----.----.--.--.-----.----|  .-----.-----.-----.</div><div class="line">|   |___|  -__|   _|  |  |  -__|   _|  |  -__|__ --|__ --|</div><div class="line">|____   |_____|__|  \___/|_____|__| |__|_____|_____|_____|</div><div class="line">|   |   |             The Serverless Application Framework</div><div class="line">|       |                           serverless.com, v0.5.5</div><div class="line">`-------<span class="string">'</span></div><div class="line"></div><div class="line">Use the &lt;up&gt;, &lt;down&gt;, &lt;pageup&gt;, &lt;pagedown&gt;, &lt;home&gt;, and &lt;end&gt; keys to navigate.</div><div class="line">Press &lt;enter&gt; to select/deselect, or &lt;space&gt; to select/deselect and move down.</div><div class="line">Press &lt;ctrl&gt; + a to select all, and &lt;ctrl&gt; + d to deselect all.</div><div class="line">Press &lt;ctrl&gt; + f to select all functions, and &lt;ctrl&gt; + e to select all endpoints.</div><div class="line">Press &lt;ctrl&gt; + &lt;enter&gt; to immediately deploy selected.</div><div class="line">Press &lt;escape&gt; to cancel.</div><div class="line"></div><div class="line"></div><div class="line">Serverless: Select the assets you wish to deploy:</div><div class="line">    hello</div><div class="line">      function - hello</div><div class="line">      endpoint - hello - GET</div><div class="line">    - - - - -</div><div class="line">  &gt; Deploy</div><div class="line">    Cancel</div><div class="line"></div><div class="line">Serverless: Deploying the specified functions in "dev" to the following regions: eu-west-1</div><div class="line">Serverless: ------------------------</div><div class="line">Serverless: Successfully deployed the following functions in "dev" to the following regions:</div><div class="line">Serverless: eu-west-1 ------------------------</div><div class="line">Serverless:   hello (serverless-greeints-hello): arn:aws:lambda:eu-west-1:0000000000:function:serverless-greeints-hello:dev</div><div class="line"></div><div class="line">Serverless: Deploying endpoints in "dev" to the following regions: eu-west-1</div><div class="line">Serverless: Successfully deployed endpoints in "dev" to the following regions:</div><div class="line">Serverless: eu-west-1 ------------------------</div><div class="line">Serverless:   GET - hello - https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello</div></pre></td></tr></table></figure>
<p>実際にリクエストをしてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello</div><div class="line">&#123;<span class="string">"message"</span>:<span class="string">"Hello Good bye !"</span>&#125;%</div><div class="line"></div><div class="line">curl https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello\?message\=World</div><div class="line">&#123;<span class="string">"message"</span>:<span class="string">"Hello World !"</span>&#125;%</div></pre></td></tr></table></figure>
<p>ということで、Amazon API GatewayとAWS Lambdaをひととおり触った。</p>
<h3 id="POSTメソッドに変更する"><a href="#POSTメソッドに変更する" class="headerlink" title="POSTメソッドに変更する"></a>POSTメソッドに変更する</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="deletion">-      "method": "GET",</span></div><div class="line"><span class="addition">+      "method": "POST",</span></div><div class="line"></div><div class="line"><span class="deletion">-      "requestTemplates": &#123;</span></div><div class="line"><span class="deletion">-        "application/json": "&#123;\"message\": \"$input.params('message')\"&#125;"</span></div><div class="line"><span class="deletion">-      &#125;,</span></div><div class="line"><span class="addition">+      "requestTemplates": &#123;</span></div><div class="line"><span class="addition">+        "application/json": "&#123;\"message\": \"$util.escapeJavaScript($input.json('$.message'))\"&#125;"</span></div><div class="line"><span class="addition">+      &#125;,</span></div></pre></td></tr></table></figure>
<p>jsonのpostデータをescape処理して受け取ります。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sls endpoint deploy</div><div class="line"></div><div class="line">Serverless: Deploying endpoints <span class="keyword">in</span> <span class="string">"dev"</span> to the following regions: eu-west-1</div><div class="line">Serverless: Successfully deployed endpoints <span class="keyword">in</span> <span class="string">"dev"</span> to the following regions:</div><div class="line">Serverless: eu-west-1 ------------------------</div><div class="line">Serverless:   POST - hello - https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello</div></pre></td></tr></table></figure>
<p>最後にPOSTのエンドポイントが表示された。<br>実際にリクエストを投げてみる。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -H <span class="string">"Content-type: application/json"</span> -X POST <span class="_">-d</span> <span class="string">"&#123;\"message\": \"World\"&#125;"</span> https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello</div><div class="line">&#123;<span class="string">"message"</span>:<span class="string">"Hello \"World\" !"</span>&#125;%</div></pre></td></tr></table></figure>
<p>問題なくレスポンスが帰ってきた。</p>
<h3 id="Slack-Bot-を作ってみる"><a href="#Slack-Bot-を作ってみる" class="headerlink" title="Slack Bot を作ってみる"></a>Slack Bot を作ってみる</h3><p>ここまで出来たので、これらを使ってSlack Botを作ってみる。<br>まずは<a href="https://api.slack.com/web" target="_blank" rel="external">api.slack.com</a>からTokenを発行する。</p>
<p>続いて、AWS Lambdaで実行される<code>handler.js</code>を編集する。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params">data, separator</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> res = &#123;&#125;;</div><div class="line">  data.body.split(<span class="string">'&amp;'</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> tmp = val.split(separator, <span class="number">2</span>);</div><div class="line">    <span class="keyword">var</span> k = tmp[<span class="number">0</span>],</div><div class="line">        v = tmp[<span class="number">1</span>];</div><div class="line">    res[k] = v;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports.handler = <span class="function"><span class="keyword">function</span>(<span class="params">event, context</span>) </span>&#123;</div><div class="line">  <span class="comment">// Incoming Web Hook のURL</span></div><div class="line">  <span class="keyword">var</span> SLACK_HOOKURL = SLACK_INCCOMING_WEBHOOK_URL;</div><div class="line">  <span class="keyword">var</span> SLACK_TOKEN = SLACK_TOKEN;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> data = parse(event, <span class="string">'='</span>);</div><div class="line">  <span class="keyword">var</span> user_name = data.user_name;</div><div class="line">  <span class="keyword">var</span> response_text = <span class="built_in">decodeURIComponent</span>(data.text.replace(data.trigger_word, <span class="string">''</span>).replace(<span class="regexp">/\+/g</span>, <span class="string">' '</span>));</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(data.token !== SLACK_TOKEN) &#123;</div><div class="line">    <span class="keyword">return</span> context.done(&#123;<span class="string">'text'</span>: <span class="string">':sob: Failed Invalid Token'</span> &#125;, <span class="literal">null</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> message = <span class="string">":hand: @"</span> + user_name + <span class="string">" Hello "</span> + (response_text || <span class="string">"Good bye"</span>);</div><div class="line">  <span class="keyword">var</span> options = &#123;</div><div class="line">    <span class="attr">hostname</span>: <span class="string">'hooks.slack.com'</span>,</div><div class="line">    <span class="attr">port</span>: <span class="number">443</span>,</div><div class="line">    <span class="attr">path</span>: SLACK_HOOKURL,</div><div class="line">    <span class="attr">method</span>: <span class="string">'POST'</span>,</div><div class="line">    <span class="attr">headers</span>: &#123; <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>, &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// @metionを使うために`link_names`を設定</span></div><div class="line">  <span class="keyword">var</span> data = &#123;</div><div class="line">    <span class="string">"text"</span>: message,</div><div class="line">    <span class="string">"link_names"</span>: <span class="number">1</span>,</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> req = https.request(options, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</div><div class="line">    res</div><div class="line">    .on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</div><div class="line">        <span class="comment">// If success, post a response back into the Slack channel</span></div><div class="line">        <span class="keyword">return</span> context.done(<span class="literal">null</span>, &#123;<span class="string">'text'</span>: <span class="string">':ok_woman: Success'</span>&#125;);</div><div class="line">    &#125;)</div><div class="line">    .on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> context.done(&#123;<span class="string">'text'</span>: <span class="string">':sob: Failed '</span> + e.message&#125;, <span class="literal">null</span>);</div><div class="line">    &#125;)</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  req.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> context.done(&#123;<span class="string">'text'</span>: <span class="string">':sob: Failed '</span> + e.message&#125;, <span class="literal">null</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  req.write(<span class="built_in">JSON</span>.stringify(data));</div><div class="line">  req.end();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>シンプルにslack apiを実行するだけのBotにした。</p>
<p>次にAWSからSlack Botに対して送られたメッセージにHookする<a href="https://api.slack.com/incoming-webhooks" target="_blank" rel="external">Incoming WebHook</a>を作成する。</p>
<p>今回は設定項目を以下のようにした</p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>Post to Channel</td>
<td>#general (default)</td>
</tr>
<tr>
<td>Webhook URL</td>
<td><a href="https://hooks.slack.com/services/XXXXXXXX/YYYYYYYYY" target="_blank" rel="external">https://hooks.slack.com/services/XXXXXXXX/YYYYYYYYY</a></td>
</tr>
<tr>
<td>Customize Name</td>
<td>incoming-webhook (default)</td>
</tr>
</tbody>
</table>
<p>ここで作成したURLに対してPOSTすることでSlackに通知される。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H <span class="string">'Content-type: application/json'</span> --data <span class="string">'&#123;"text": "@here This is posted to &lt;#general&gt; and comes from *monkey-bot*.", "channel": "#general", "username": "monkey-bot", "icon_emoji": ":monkey_face:", "link_names": 1&#125;'</span> https://hooks.slack.com/services/XXXXXX/YYYYYY/ZZZZZZ</div></pre></td></tr></table></figure>
<p><img src="/images/2016/05/12/serverless6.png" alt=""></p>
<p>続いて、Slack BotがメッセージをAWSに送信するために使うHookとなる<a href="https://api.slack.com/outgoing-webhooks" target="_blank" rel="external">Outgoing WebHook</a>を作成する。</p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>Channel</td>
<td>#general (default)</td>
</tr>
<tr>
<td>Trigger Word(s)</td>
<td>greet</td>
</tr>
<tr>
<td>URL(s)</td>
<td><a href="https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello" target="_blank" rel="external">https://xxxxxxxxx.execute-api.eu-west-1.amazonaws.com/dev/hello</a><br>(作成したGate Way API URL)</td>
</tr>
<tr>
<td>Token</td>
<td>generateされているtoken</td>
</tr>
<tr>
<td>Customize Name</td>
<td>outgoing-webhook (default)</td>
</tr>
</tbody>
</table>
<p><code>Trigger Word</code>でslackに投稿すると、URLにpostされるようになる。</p>
<p>ここまでできたので、実際にBotで遊んでみる。</p>
<p><img src="/images/2016/05/12/serverless7.png" alt=""></p>
<p>ということで、Serverless を使って、Amazon Gate Way API &amp; AWS LambdaでSlack Botができた。<br>サーバーを作り、管理することないため、アプリケーションに注力できるたりが素晴らしい。</p>
<p>AWS Lambdaのようなイベントドリブンなサービスを使うことで、Botやインターネットに接続する機器からのリクエストを受け付けるアプリケーションが容易に作成できる。<br>またイベント数によりオートスケールしていくので、サーバー管理も気にすることはない。</p>
<p>AWS Lambdaの他にもMicrosoftは<a href="https://azure.microsoft.com/ja-jp/documentation/services/functions/" target="_blank" rel="external">Azure Functions</a>というイベント駆動システムを提供している。</p>
<p>今回利用したServerlessはAmazon API GatewayとAWS Lambdaを中心としたイベントドリブンなサービスを開発するフレームワークだったが、AIやBotの盛り上がりから今後もっと様々なプロジェクト生まれていきそうな感じがする。</p>
<h3 id="参考にしたページ"><a href="#参考にしたページ" class="headerlink" title="参考にしたページ"></a>参考にしたページ</h3><p><a href="http://docs.serverless.com/docs/installing-serverless" target="_blank" rel="external">serverless docs</a><br><a href="http://davidcai.github.io/blog/posts/serverless-and-cors/" target="_blank" rel="external">Serverless Framework &amp; AWS API Gateway CORS</a><br><a href="https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/welcome.html" target="_blank" rel="external">Amazon API Gateway とは?</a><br><a href="http://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html" target="_blank" rel="external">API Gateway のマッピングテンプレートリファレンス</a></p>

    
  </div>

  
    <footer class="article-footer">

      
        <aside class="google-adsence">
          
<!-- Google Adsence -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-4054575508733221"
   data-ad-slot="9493597992"
   data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- End Google Adsence -->


        </aside>
      

      <div class="share_content">
  <div class="hatena_sharebox">
    
      <a href="http://b.hatena.ne.jp/entry/blog.kazu69.net/2016/05/12/playing-aws-lamda-api-gateway-using-serverless-framework/" class="hatena-bookmark-button" data-hatena-bookmark-title="Serverless Frameworkを使ってAWS LambdaとAPI Gatewayを試した" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  </div>
  
    <div class="addthis addthis_toolbox addthis_default_style">
      
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
      
      
        <a class="addthis_button_tweet"></a>
      
      
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
      
      
      <!-- <a class="addthis_counter addthis_pill_style"></a> -->
    </div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55a4f49a45ced975"></script>
  
</div>

      
        <a href="http://blog.kazu69.net/2016/05/12/playing-aws-lamda-api-gateway-using-serverless-framework/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  

  
    
<nav id="article-nav">
  <div class="article-nav">
    
      <a href="/2016/06/06/start-node-server-with-systemd/" id="article-nav-newer" class="article-nav-link article-nav-link-newer">
        <span class="article-nav-caption">Newer - </span>
        <span class="article-nav-title">
          
            systemdを使ってnodejsサーバー起動する
          
        </span>
      </a>
    
    
      <a href="/2016/05/04/tracking-noscript-user-measurement-protocol/" id="article-nav-older" class="article-nav-link article-nav-link-older">
        <span class="article-nav-caption">Older - </span>
        <span class="article-nav-title">
          
            Google AnalyticsのMeasurement ProtocolでJavaScript無効なユーザーをトラッキング
          
        </span>
        </span>
      </a>
    
  </div>
</nav>

  
</article>


<section class="comments" id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      
    </main>
    <footer id="footer" role="contentinfo">
  
  <div class="footer-cotent">
    <small>&copy; 2016 kazu69</small>
    <span class="generator">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
  </div>
</footer>
    
<script>
  var disqus_shortname = '69log';
  
  var disqus_url = 'http://blog.kazu69.net/2016/05/12/playing-aws-lamda-api-gateway-using-serverless-framework/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</body>
</html>